---
/**
 * Legacy catch-all route - Redirects to locale-prefixed URLs
 *
 * This handles any direct access to paths like /platform/user-management
 * and redirects to /en/platform/user-management
 *
 * Phase 0: Uses getCollection() instead of API call
 */
import { getCollection } from 'astro:content';
import { defaultLocale } from '../lib/i18n';

export async function getStaticPaths() {
  try {
    const allDocs = await getCollection('docs');

    const paths = allDocs
      .filter(entry => entry.data.path || entry.data.slug)
      .map(entry => {
        const doc = entry.data;
        if (doc.path) {
          return doc.path
            .replace(/\.mdx?$/, '')
            .replace(/^src\/content\//, '')
            .replace(/^content\//, '')
            .replace(/^[a-z]{2}\//, '')
            .replace(/^docs\//, '')
            .replace(/^\/+/, '')
            .toLowerCase();
        }
        return doc.slug;
      })
      .filter(Boolean)
      .filter(slug => slug && slug.includes('/'));

    // Deduplicate slugs (multiple locales produce the same slug)
    const uniqueSlugs = [...new Set(paths)];

    return uniqueSlugs.map(slug => ({
      params: { slug },
    }));
  } catch (error) {
    console.error('Failed to generate legacy redirect paths:', error);
    return [];
  }
}

const slug = Astro.params.slug;

return Astro.redirect(`/${defaultLocale}/${slug}`, 301);
---
