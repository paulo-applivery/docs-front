---
/**
 * CookieBanner - Lightweight GDPR-compliant cookie consent
 *
 * Position options:
 * - 'footer': Full-width bar at bottom
 * - 'bottom-right': Compact card at bottom-right
 * - 'bottom-left': Compact card at bottom-left
 */

export interface Props {
  mode?: 'none' | 'simple' | 'detailed';
  position?: 'footer' | 'bottom-right' | 'bottom-left';
  privacyPolicyUrl?: string;
  siteName?: string;
}

import Icon from './Icon';

const {
  mode = 'simple',
  position = 'bottom-right',
  privacyPolicyUrl = '/privacy',
  siteName = 'this site'
} = Astro.props;

const isCard = position !== 'footer';
const isDetailed = mode === 'detailed';

if (mode === 'none') {
  return null;
}
---

<div
  id="cookie-banner"
  role="dialog"
  aria-modal="false"
  aria-label="Cookie consent"
  data-mode={mode}
  data-position={position}
  data-privacy-url={privacyPolicyUrl}
  data-site-name={siteName}
  hidden
>
  {isDetailed ? (
    <>
      <div class="cb-main">
        <p class="cb-text">
          We use cookies to improve your experience.
          {!isCard && (
            <>
              {' '}
              <a href={privacyPolicyUrl} class="cb-link">Learn more</a>
            </>
          )}
        </p>
        <div class="cb-btns">
          <button class="cb-btn cb-ghost" data-action="prefs">Customize</button>
          <button class="cb-btn cb-primary" data-action="accept">Accept All</button>
        </div>
        {isCard && <a href={privacyPolicyUrl} class="cb-policy">Privacy Policy</a>}
      </div>
      <div class="cb-prefs" hidden>
        <p class="cb-title">Cookie Preferences</p>
        <label class="cb-opt">
          <input type="checkbox" checked disabled />
          <Icon name="check" className="cb-opt-icon" aria-hidden={true} client:only="react" />
          <span>Essential</span>
        </label>
        <label class="cb-opt">
          <input type="checkbox" id="cb-analytics" />
          <Icon name="check" className="cb-opt-icon" aria-hidden={true} client:only="react" />
          <span>Analytics</span>
        </label>
        <label class="cb-opt">
          <input type="checkbox" id="cb-marketing" />
          <Icon name="check" className="cb-opt-icon" aria-hidden={true} client:only="react" />
          <span>Marketing</span>
        </label>
        <div class="cb-btns">
          <button class="cb-btn cb-ghost" data-action="decline">Reject All</button>
          <button class="cb-btn cb-primary" data-action="save">Save</button>
        </div>
      </div>
    </>
  ) : (
    <div class="cb-main">
      <p class="cb-text">
        We use cookies to improve your experience.
        {!isCard && (
          <>
            {' '}
            <a href={privacyPolicyUrl} class="cb-link">Learn more</a>
          </>
        )}
      </p>
      <div class="cb-btns">
        <button class="cb-btn cb-ghost" data-action="decline">Decline</button>
        <button class="cb-btn cb-primary" data-action="accept">Accept</button>
      </div>
      {isCard && <a href={privacyPolicyUrl} class="cb-policy">Privacy Policy</a>}
    </div>
  )}
</div>

<script is:inline>
(function() {
  const CONSENT_KEY = 'cookie-consent';
  const PREFS_KEY = 'cookie-preferences';

  if (localStorage.getItem(CONSENT_KEY)) return;

  const banner = document.getElementById('cookie-banner');
  if (!banner) return;

  const position = banner.dataset.position;

  banner.className = 'cb cb-' + position;

  banner.hidden = false;

  banner.addEventListener('click', function(e) {
    const btn = e.target.closest('button');
    if (!btn) return;
    const action = btn.dataset.action;
    const prefs = banner.querySelector('.cb-prefs');
    const main = banner.querySelector('.cb-main');

    if (action === 'accept') save({ essential: true, analytics: true, marketing: true });
    else if (action === 'decline') save({ essential: true, analytics: false, marketing: false });
    else if (action === 'prefs' && prefs && main) { main.hidden = true; prefs.hidden = false; }
    else if (action === 'back' && prefs && main) { prefs.hidden = true; main.hidden = false; }
    else if (action === 'save') {
      const a = document.getElementById('cb-analytics');
      const m = document.getElementById('cb-marketing');
      save({ essential: true, analytics: a?.checked || false, marketing: m?.checked || false });
    }
  });

  function save(p) {
    localStorage.setItem(CONSENT_KEY, 'true');
    localStorage.setItem(PREFS_KEY, JSON.stringify(p));
    banner.hidden = true;
    window.dispatchEvent(new CustomEvent('cookieConsent', { detail: p }));
  }
})();
</script>

<style is:global>
  .cb {
    position: fixed;
    z-index: 9999;
    font: 13px/1.4 var(--font-body, system-ui, sans-serif);
    color: var(--color-text-primary, #1f2937);
  }

  /* Footer position */
  .cb-footer {
    bottom: 0;
    left: 0;
    right: 0;
    padding: 12px 16px;
    background: var(--color-surface, #fff);
    border-top: 1px solid var(--color-border, #e5e7eb);
    box-shadow: 0 -2px 8px rgb(0 0 0 / 0.08);
  }
  .cb-footer .cb-main {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    flex-wrap: wrap;
  }

  /* Card positions */
  .cb-bottom-right,
  .cb-bottom-left {
    bottom: 16px;
    width: 320px;
    max-width: calc(100vw - 32px);
    padding: 16px;
    background: var(--color-surface, #fff);
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: 16px;
    box-shadow: 0 4px 20px rgb(0 0 0 / 0.12);
  }
  .cb-bottom-right { right: 16px; }
  .cb-bottom-left { left: 16px; }

  .cb-bottom-right .cb-main,
  .cb-bottom-left .cb-main {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  /* Dark mode */
  html.dark .cb {
    color: var(--color-text-primary, #f1f5f9);
  }
  html.dark .cb-footer,
  html.dark .cb-bottom-right,
  html.dark .cb-bottom-left {
    background: var(--color-surface, #1e293b);
    border-color: var(--color-border, #334155);
  }

  /* Text */
  .cb-text {
    margin: 0;
    color: var(--color-text-secondary, #6b7280);
  }
  html.dark .cb-text {
    color: var(--color-text-secondary, #9ca3af);
  }
  .cb-link {
    color: var(--color-primary, #10b981);
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  .cb-policy {
    font-size: 11px;
    color: var(--color-text-muted, #9ca3af);
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  html.dark .cb-policy {
    color: var(--color-text-muted, #6b7280);
  }

  /* Buttons */
  .cb-btns {
    display: flex;
    gap: 8px;
  }
  .cb-bottom-right .cb-btns,
  .cb-bottom-left .cb-btns {
    width: 100%;
  }
  .cb-btn {
    padding: 8px 14px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid transparent;
    transition: background 0.15s;
  }
  .cb-bottom-right .cb-btn,
  .cb-bottom-left .cb-btn {
    flex: 1;
  }
  .cb-primary {
    background: var(--color-primary, #10b981);
    color: #fff;
  }
  .cb-primary:hover {
    background: var(--color-primary-dark, #059669);
  }
  .cb-ghost {
    background: transparent;
    border-color: var(--color-border, #e5e7eb);
    color: var(--color-text-primary, #374151);
  }
  html.dark .cb-ghost {
    border-color: var(--color-border, #475569);
    color: var(--color-text-primary, #e2e8f0);
  }
  .cb-ghost:hover {
    background: var(--color-background-secondary, #f3f4f6);
  }
  html.dark .cb-ghost:hover {
    background: var(--color-background-secondary, #334155);
  }

  /* Preferences panel */
  .cb-prefs {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .cb-title {
    margin: 0 0 4px;
    font-weight: 600;
    font-size: 14px;
  }
  .cb-opt {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 13px;
    color: var(--color-text-secondary, #6b7280);
  }
  .cb-opt-icon {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
  }
  html.dark .cb-opt {
    color: var(--color-text-secondary, #9ca3af);
  }
  .cb-opt input {
    accent-color: var(--color-primary, #10b981);
  }
  .cb-prefs .cb-btns {
    margin-top: 8px;
  }

  /* Mobile */
  @media (max-width: 480px) {
    .cb-bottom-right,
    .cb-bottom-left {
      left: 8px;
      right: 8px;
      bottom: 8px;
      width: auto;
    }
    .cb-footer .cb-main {
      flex-direction: column;
      align-items: stretch;
    }
    .cb-footer .cb-btns {
      width: 100%;
    }
    .cb-footer .cb-btn {
      flex: 1;
    }
  }

  @media print {
    .cb { display: none; }
  }
</style>
