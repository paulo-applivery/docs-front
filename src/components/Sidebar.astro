---
/**
 * Sidebar Component - Left navigation panel
 * Mintlify-style with collapsible sections and icons
 * Supports both auto-tree mode (from documents) and manual mode (from admin config)
 */

import type { Document, SideMenuConfig, SideMenuItem } from '../lib/cms';
import {
  locales as i18nLocales,
  localeNames,
  isValidLocale,
  defaultLocale as i18nDefaultLocale,
  type Locale
} from '../lib/i18n';
import Icon from './Icon';
import { iconMap, type IconName } from '../lib/icons';

interface Props {
  documents: Document[];
  currentPath: string;
  logoUrl?: string;
  logoDarkUrl?: string;
  logoIconUrl?: string;
  logoIconDarkUrl?: string;
  logoWidth?: number;
  logoHeight?: number;
  siteName?: string;
  supportedLocales?: string[];
  defaultLocale?: string;
  sideMenu?: SideMenuConfig;
  /** Current locale for the page */
  locale?: Locale;
  /** Available translations for the current document */
  availableTranslations?: Locale[];
  /** Mapping of locale to translated slug for URL building */
  translationSlugs?: Partial<Record<Locale, string>>;
}

const {
  documents,
  currentPath,
  logoUrl,
  logoDarkUrl,
  logoIconUrl,
  logoIconDarkUrl,
  logoWidth = 120,
  logoHeight = 32,
  siteName = 'Docs',
  supportedLocales = [],
  defaultLocale = 'en',
  sideMenu,
  locale: propLocale,
  availableTranslations = [],
  translationSlugs = {},
} = Astro.props;

// Determine current locale from prop, URL, or default
const urlLocale = Astro.url.pathname.split('/').filter(Boolean)[0];
const currentLocale: Locale = propLocale || (isValidLocale(urlLocale) ? urlLocale : i18nDefaultLocale);

// Determine navigation mode
const isManualMode = sideMenu?.mode === 'manual' && sideMenu.items && sideMenu.items.length > 0;

// Extract products and tabs from sideMenu (for folder-based navigation)
interface FolderNavItem {
  id: string;
  label: string;
  icon?: string;
  folder?: string;
  collection?: string;
  defaultActive?: boolean;
}

const products: FolderNavItem[] = [];
const tabs: FolderNavItem[] = [];
const nonProductItems: SideMenuItem[] = [];

if (isManualMode && sideMenu?.items) {
  for (const item of sideMenu.items) {
    if (item.type === 'product' && !item.hidden) {
      products.push({
        id: item.id,
        label: item.label,
        icon: item.icon,
        folder: item.folder,
        collection: item.collection || 'docs',
        defaultActive: item.defaultActive,
      });
    } else if (item.type === 'tab' && !item.hidden) {
      tabs.push({
        id: item.id,
        label: item.label,
        icon: item.icon,
        folder: item.folder,
        collection: item.collection || 'docs',
        defaultActive: item.defaultActive,
      });
    } else if (item.type !== 'tab' && !item.hidden) {
      // Exclude tabs from regular items - they're rendered in header
      nonProductItems.push(item);
    }
  }
}

// Determine which product is active based on current path or default
// URL structure: /{locale}/{folder}/... (no /docs prefix since subdomain indicates docs)
const activeProduct = products.find(p => {
  if (!p.folder) return false;

  const folder = p.folder.replace(/^\/|\/$/g, '');

  // Normalize current path and remove leading/trailing slashes
  const normPath = currentPath.replace(/^\/|\/$/g, '');
  const parts = normPath.split('/');

  // Path format: {locale}/{folder}/...
  // So parts[0] = locale (en, es, etc.), parts[1] = folder (device-management, platform, etc.)
  if (parts.length >= 2) {
    const pathFolder = parts[1]; // The folder after locale
    if (pathFolder === folder) return true;
  }

  // Also check without locale for backwards compatibility
  if (normPath === folder || normPath.startsWith(folder + '/')) return true;

  return false;
}) || products.find(p => p.defaultActive) || products[0];

const hasProducts = products.length > 0;

// Determine which tab is active by default
const defaultActiveTab = tabs.find(t => t.defaultActive) || tabs[0];
const hasTabs = tabs.length > 0;
const tabsJson = JSON.stringify(tabs);

// Group documents by section/category
interface NavGroup {
  title: string;
  icon?: string;
  items: NavItem[];
  subgroups?: NavGroup[];
}

interface NavItem {
  label: string;
  href: string;
  icon?: string;
  active: boolean;
}

/**
 * Extract a clean slug from the document path
 * Matches the logic in [...slug].astro
 * Removes: file extension, content/ prefix, locale prefix (en/, es/, etc.), docs/ prefix
 */
function extractSlugFromPath(path: string): string {
  let slug = path.replace(/\.mdx?$/, '');           // Remove file extension
  slug = slug.replace(/^src\/content\//, '');        // Remove src/content/ prefix
  slug = slug.replace(/^content\//, '');             // Remove content/ prefix
  slug = slug.replace(/^[a-z]{2}\//, '');            // Remove locale prefix (en/, es/, etc.)
  slug = slug.replace(/^docs\//, '');                // Remove docs/ prefix (subdomain handles this)
  slug = slug.replace(/^\/+/, '');                   // Remove leading slashes
  return slug;
}

/**
 * Format a path segment into a readable title
 */
function formatTitle(segment: string): string {
  return segment
    .replace(/-/g, ' ')
    .replace(/_/g, ' ')
    .replace(/\b\w/g, c => c.toUpperCase());
}

/**
 * Build hierarchical navigation from document paths
 * Groups by folder structure for a proper sidebar tree
 */
function buildNavigation(docs: Document[]): NavGroup[] {
  // Sort by sidebar_position, order, or path
  const sortedDocs = [...docs].sort((a, b) => {
    const posA = a.sidebar_position ?? a.order_num ?? a.weight ?? 999;
    const posB = b.sidebar_position ?? b.order_num ?? b.weight ?? 999;
    if (posA !== posB) return posA - posB;
    return (a.path || '').localeCompare(b.path || '');
  });

  // Build a tree structure from paths
  interface TreeNode {
    title: string;
    items: NavItem[];
    children: Record<string, TreeNode>;
    icon?: string;
  }

  const root: Record<string, TreeNode> = {};

  for (const doc of sortedDocs) {
    if (doc.visible === false || doc.visible === 0) continue;

    // Skip index files - they are archive pages, not menu items
    if (doc.path) {
      const filename = doc.path.split('/').pop() || '';
      if (/^index\.mdx?$/i.test(filename)) continue;
    }
    if (doc.type === 'archive') continue;

    // Build href with locale prefix
    // Always derive from path to preserve folder hierarchy
    let href: string;
    if (doc.path) {
      href = `/${currentLocale}/${extractSlugFromPath(doc.path).toLowerCase()}`;
    } else if (doc.slug) {
      const cleanSlug = doc.slug.replace(/^docs\//, '');
      href = `/${currentLocale}/${cleanSlug.toLowerCase()}`;
    } else {
      href = `/${currentLocale}/${doc.id}`;
    }

    const navItem: NavItem = {
      label: doc.item_name || doc.title,
      href,
      icon: doc.sidebar_icon || doc.icon,
      active: currentPath === href || currentPath.startsWith(href + '/'),
    };

    // Extract path parts (skip collection, get folder structure)
    // e.g., docs/platform/workspaces/Overview.md -> [platform, workspaces]
    const pathParts = doc.path ? extractSlugFromPath(doc.path).split('/') : [];

    // Skip collection (first part) and filename (last part) to get folders
    const folders = pathParts.slice(1, -1);

    if (folders.length === 0) {
      // Root level document - put in General or collection-based group
      const groupKey = doc.collection || 'General';
      if (!root[groupKey]) {
        root[groupKey] = { title: formatTitle(groupKey), items: [], children: {} };
      }
      root[groupKey].items.push(navItem);
    } else {
      // Navigate/create the tree structure
      let current = root;
      for (let i = 0; i < folders.length; i++) {
        const folder = folders[i];
        const key = folder;

        if (i === 0) {
          // First level folder
          if (!current[key]) {
            current[key] = {
              title: formatTitle(folder),
              items: [],
              children: {},
              icon: doc.sidebar_icon || doc.icon
            };
          }
          if (i === folders.length - 1) {
            // This is the deepest folder, add item here
            current[key].items.push(navItem);
          }
          current = { [key]: current[key] };
        } else {
          // Deeper levels
          const parent = Object.values(current)[0];
          if (!parent.children[key]) {
            parent.children[key] = {
              title: formatTitle(folder),
              items: [],
              children: {}
            };
          }
          if (i === folders.length - 1) {
            parent.children[key].items.push(navItem);
          }
          current = parent.children;
        }
      }
    }
  }

  // Convert tree to NavGroup array with proper nesting
  function treeToGroups(tree: Record<string, TreeNode>): NavGroup[] {
    return Object.values(tree).map(node => ({
      title: node.title,
      icon: node.icon,
      items: node.items,
      subgroups: Object.keys(node.children).length > 0 ? treeToGroups(node.children) : undefined,
    }));
  }

  return treeToGroups(root);
}

/**
 * Convert SideMenuItem from admin config to NavGroup format
 * Handles all item types: anchor, tab, dropdown, group, language, product, version, page
 */
function convertSideMenuToNavGroups(items: SideMenuItem[]): NavGroup[] {
  const groups: NavGroup[] = [];

  function processChildren(children: SideMenuItem[]): { navItems: NavItem[], subgroups: NavGroup[] } {
    const navItems: NavItem[] = [];
    const subgroups: NavGroup[] = [];

    for (const child of children) {
      if (child.hidden) continue;

      // Check if this child has nested children (becomes a subgroup)
      if (['group', 'dropdown', 'tab'].includes(child.type) && child.children && child.children.length > 0) {
        const nested = processChildren(child.children);
        subgroups.push({
          title: child.label,
          icon: child.icon,
          items: nested.navItems,
          subgroups: nested.subgroups.length > 0 ? nested.subgroups : undefined,
        });
      } else {
        // Regular nav item (page, anchor, or childless group)
        const isExternal = child.href?.startsWith('http');
        navItems.push({
          label: child.label,
          href: child.href || '#',
          icon: child.icon,
          active: !isExternal && (currentPath === child.href || currentPath.startsWith((child.href || '') + '/')),
        });
      }
    }

    return { navItems, subgroups };
  }

  for (const item of items) {
    if (item.hidden) continue;

    // Items that can have children become groups
    if (['tab', 'dropdown', 'group'].includes(item.type)) {
      if (item.children && item.children.length > 0) {
        const { navItems, subgroups } = processChildren(item.children);
        groups.push({
          title: item.label,
          icon: item.icon,
          items: navItems,
          subgroups: subgroups.length > 0 ? subgroups : undefined,
        });
      } else {
        // Empty group - still create it as a header
        groups.push({
          title: item.label,
          icon: item.icon,
          items: [],
        });
      }
    } else if (item.type === 'anchor' || item.type === 'page') {
      // Single items - add to a standalone group with same name
      const isExternal = item.href?.startsWith('http');
      groups.push({
        title: item.label,
        icon: item.icon,
        items: [{
          label: item.label,
          href: item.href || '#',
          icon: item.icon,
          active: !isExternal && (currentPath === item.href || currentPath.startsWith((item.href || '') + '/')),
        }],
      });
    } else if (item.type === 'language' || item.type === 'product' || item.type === 'version') {
      // Special selector types - render as groups
      groups.push({
        title: item.label,
        icon: item.icon,
        items: [],
      });
    }
  }

  return groups;
}

// Build navigation based on mode
// If we have products, the navigation will be loaded dynamically based on active product
// Otherwise, use the standard navigation building
const navigation = isManualMode
  ? (hasProducts ? convertSideMenuToNavGroups(nonProductItems) : convertSideMenuToNavGroups(sideMenu!.items))
  : buildNavigation(documents);

// Serialize products for client-side use
const productsJson = JSON.stringify(products);

const iconNameMap: Record<string, IconName> = {
  // Documents & Files
  folder: 'folder',
  'folder-open': 'folderOpen',
  'folder-plus': 'folderPlus',
  'folder-tree': 'folderTree',
  document: 'document',
  'file-text': 'fileText',
  'file-code': 'fileCode',
  'file-plus': 'filePlus',
  scroll: 'scroll',
  notebook: 'notebook',
  clipboard: 'clipboard',
  'clipboard-list': 'clipboardList',

  // Navigation & UI
  home: 'home',
  compass: 'compass',
  map: 'map',
  'map-pin': 'mapPin',
  bookmark: 'bookmark',
  menu: 'menu',
  'panel-left': 'panelLeft',
  'layout-dashboard': 'layoutDashboard',
  'layout-grid': 'layoutGrid',
  'layout-list': 'layoutList',

  // Settings & Config
  settings: 'settings',
  'settings-2': 'settings',
  cog: 'settings',
  'columns-3-cog': 'settings',
  wrench: 'wrench',
  sliders: 'sliders',
  'sliders-horizontal': 'slidersHorizontal',

  // Actions
  zap: 'zap',
  rocket: 'rocket',
  play: 'play',
  download: 'download',
  upload: 'upload',
  'refresh-cw': 'refreshCw',
  trash: 'trash',
  'trash-2': 'trash',
  pencil: 'pencil',
  plus: 'plus',
  copy: 'copy',
  sparkles: 'sparkles',
  lightbulb: 'lightbulb',

  // Technology & Platforms
  smartphone: 'smartphone',
  'monitor-smartphone': 'smartphone',
  tablet: 'tablet',
  'tablet-smartphone': 'tablet',
  monitor: 'monitor',
  laptop: 'laptop',
  tv: 'tv',
  watch: 'watch',
  'panel-top-open': 'panelTopOpen',

  // Operating Systems & Brands
  apple: 'apple',
  android: 'android',
  iphone: 'smartphone',
  ipad: 'tablet',
  windows: 'windows',
  chrome: 'chrome',
  github: 'github',
  gitlab: 'gitlab',
  figma: 'figma',
  slack: 'slack',
  trello: 'trello',
  twitter: 'twitter',
  youtube: 'youtube',
  linkedin: 'linkedin',
  facebook: 'facebook',
  instagram: 'instagram',
  dribbble: 'dribbble',

  // Infrastructure
  server: 'server',
  cloud: 'cloud',
  database: 'database',
  cpu: 'cpu',
  'hard-drive': 'hardDrive',
  wifi: 'wifi',
  bluetooth: 'bluetooth',

  // Development & API
  code: 'code',
  terminal: 'terminal',
  'git-branch': 'gitBranch',
  'git-commit': 'gitCommit',
  'git-merge': 'gitMerge',
  'git-pull-request': 'gitPullRequest',
  webhook: 'webhook',
  api: 'api',
  binary: 'binary',
  bug: 'bug',

  // Integrations & Plugins
  plug: 'plug',
  puzzle: 'puzzle',
  package: 'package',
  layers: 'layers',
  box: 'box',
  blocks: 'blocks',
  component: 'component',

  // Security
  shield: 'shield',
  'shield-check': 'shieldCheck',
  'shield-alert': 'shieldAlert',
  lock: 'lock',
  'lock-open': 'lockOpen',
  key: 'key',
  fingerprint: 'fingerprint',
  eye: 'eye',
  'eye-off': 'eyeOff',

  // Documentation
  book: 'book',
  'book-open': 'bookOpen',
  'book-marked': 'bookMarked',

  // Users & Organization
  user: 'user',
  'user-check': 'userCheck',
  'user-plus': 'userPlus',
  users: 'users',
  building: 'building',
  briefcase: 'briefcase',

  // Communication
  bell: 'bell',
  mail: 'mail',
  'message-square': 'messageSquare',
  'message-circle': 'messageCircle',
  phone: 'phone',
  video: 'video',
  'help-circle': 'helpCircle',

  // Analytics & Data
  'bar-chart': 'barChart',
  'bar-chart-2': 'barChart',
  'line-chart': 'lineChart',
  'pie-chart': 'pieChart',
  'trending-up': 'trendingUp',
  activity: 'activity',

  // Search & Status
  search: 'search',
  check: 'check',
  'check-circle': 'checkCircle',
  info: 'info',
  'alert-circle': 'alertCircle',
  'alert-triangle': 'alertTriangle',
  x: 'x',
  'x-circle': 'xCircle',
  link: 'link',
  'link-2': 'link2',
  'external-link': 'externalLink',

  // Misc
  star: 'star',
  heart: 'heart',
  flag: 'flag',
  tag: 'tag',
  globe: 'globe',
  'globe-2': 'globe2',
  image: 'image',
  bot: 'bot',
  palette: 'palette',
  history: 'history',
  'list-tree': 'listTree',
  'list-ordered': 'listOrdered',
  'pen-line': 'penLine',
  'grip-vertical': 'gripVertical',
  'more-vertical': 'moreVertical',
  'table-properties': 'tableProperties',
  square: 'square',

  // Extended icons (synced from CMS icon picker)
  // Devices & peripherals
  'airbuds': 'airbuds',
  'airbuds-case': 'airbudsCase',
  'airbuds-charge': 'airbudsCharge',
  'boombox': 'boombox',
  'cassette': 'cassette',
  'cloud-storage': 'cloudStorage',
  'devices': 'devices',
  'diskette': 'diskette',
  'display': 'display',
  'flash-drive': 'flashDrive',
  'gameboy': 'gameboy',
  'gamepad': 'gamepad',
  'gamepad-minimalistic': 'gamepadMinimalistic',
  'gamepad-old': 'gamepadOld',
  'headphones': 'headphones',
  'headphones-sound': 'headphonesSound',
  'headphones-square': 'headphonesSquare',
  'keyboard': 'keyboard',
  'laptop-2': 'laptop2',
  'laptop-minimalistic': 'laptopMinimalistic',
  'lightning': 'lightning',
  'magic-stick': 'magicStick',
  'map-arrow-down': 'mapArrowDown',
  'map-arrow-up': 'mapArrowUp',
  'monitor-camera': 'monitorCamera',
  'mouse': 'mouse',
  'printer': 'printer',
  'printer-minimalistic': 'printerMinimalistic',
  'projector': 'projector',
  'sd-card': 'sdCard',
  'sim-card': 'simCard',
  'slider-horizontal': 'sliderHorizontal',
  'slider-vertical': 'sliderVertical',
  'smart-speaker': 'smartSpeaker',
  'smartphone-2': 'smartphone2',
  'smartphone-rotate': 'smartphoneRotate',
  'smartphone-update': 'smartphoneUpdate',
  'smartphone-vibration': 'smartphoneVibration',
  'socket': 'socket',
  'ssd-round': 'ssdRound',
  'ssd-square': 'ssdSquare',
  'telescope': 'telescope',
  'turntable': 'turntable',
  'weigher': 'weigher',
  'wireless-charge': 'wirelessCharge',

  // Actions & editor
  'arrow-down': 'arrowDown',
  'arrow-up': 'arrowUp',
  'bold': 'bold',
  'chevron-down': 'chevronDown',
  'chevron-left': 'chevronLeft',
  'chevron-right': 'chevronRight',
  'chevron-up': 'chevronUp',
  'command': 'command',
  'heading-1': 'heading1',
  'heading-2': 'heading2',
  'heading-3': 'heading3',
  'italic': 'italic',
  'list': 'list',
  'list-check': 'listCheck',
  'loader-2': 'loader2',
  'log-out': 'logOut',
  'minus': 'minus',
  'more-horizontal': 'moreHorizontal',
  'moon': 'moon',
  'quote': 'quote',
  'redo': 'redo',
  'strikethrough': 'strikethrough',
  'sun': 'sun',
  'underline': 'underline',
  'undo': 'undo',

  // Development & integrations
  'bar-chart-3': 'barChart3',
  'braces': 'braces',
  'brackets': 'brackets',
  'bug-off': 'bugOff',
  'circuit-board': 'circuitBoard',
  'code-2': 'code2',
  'file-json': 'fileJson',
  'flask-conical': 'flaskConical',
  'nfc': 'nfc',
  'radio': 'radio',
  'terminal-square': 'terminalSquare',
  'test-tube': 'testTube',

  // Security & misc
  'bell-ring': 'bellRing',
  'building-2': 'building2',
  'check-circle-2': 'checkCircle2',
  'id-card': 'idCard',
  'key-round': 'keyRound',
  'layers-2': 'layers2',
  'memory-stick': 'memoryStick',
  'package-open': 'packageOpen',
  'plug-2': 'plug2',
  'scan': 'scan',
  'scan-face': 'scanFace',
  'shield-off': 'shieldOff',
  'tags': 'tags',
  'toggle-left': 'toggleLeft',
  'toggle-right': 'toggleRight',
  'trending-down': 'trendingDown',
  'unplug': 'unplug',
  'zap-off': 'zapOff',

  // Aliases
  'boxes': 'boxes',
};

function getIconName(iconName?: string): IconName {
  if (!iconName) return 'document';
  return iconNameMap[iconName.toLowerCase()] || 'document';
}

// Build languages array from supportedLocales (fallback to i18n locales)
const languages = supportedLocales.length > 0
  ? supportedLocales.map(code => ({ code: code.toUpperCase() }))
  : i18nLocales.map(code => ({ code: code.toUpperCase() }));

// Get current language display
const currentLang = languages.find(l => l.code.toLowerCase() === currentLocale) || languages[0];

// Determine which translations are available for the smart language selector
const effectiveTranslations: Locale[] = availableTranslations.length > 0
  ? availableTranslations
  : [currentLocale]; // If not provided, only show current locale

// CMS URL for client-side navigation API calls
const cmsUrl = import.meta.env.PUBLIC_CMS_URL || import.meta.env.CMS_URL || '';
---

<aside
  class="sidebar"
  data-cms-url={cmsUrl}
  data-icon-name-map={JSON.stringify(iconNameMap)}
  data-icon-map={JSON.stringify(iconMap)}
>
  <!-- Logo / Site Name -->
  <div class="sidebar-header">
    <a href="/" class="flex items-center gap-3">
      {logoUrl ? (
        <div class="sidebar-logo">
          {/* Light mode logo */}
          <img
            src={logoUrl}
            alt={siteName}
            class={`logo-light ${logoDarkUrl ? 'dark:hidden' : ''}`}
            style={`max-width: ${logoWidth}px; max-height: ${logoHeight}px; height: auto; width: auto;`}
          />
          {/* Dark mode logo (if provided) */}
          {logoDarkUrl && (
            <img
              src={logoDarkUrl}
              alt={siteName}
              class="logo-dark hidden dark:block"
              style={`max-width: ${logoWidth}px; max-height: ${logoHeight}px; height: auto; width: auto;`}
            />
          )}
        </div>
      ) : (logoIconUrl || logoIconDarkUrl) ? (
        <div class="sidebar-logo">
          {/* Light mode logo icon */}
          <img
            src={logoIconUrl || logoIconDarkUrl}
            alt={siteName}
            class={`logo-light ${logoIconDarkUrl ? 'dark:hidden' : ''}`}
            style={`max-width: 32px; max-height: 32px; height: auto; width: auto;`}
          />
          {/* Dark mode logo icon (if provided) */}
          {logoIconDarkUrl && (
            <img
              src={logoIconDarkUrl}
              alt={siteName}
              class="logo-dark hidden dark:block"
              style={`max-width: 32px; max-height: 32px; height: auto; width: auto;`}
            />
          )}
          <span class="font-semibold text-[var(--color-text-primary)]">{siteName}</span>
        </div>
      ) : (
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-lg bg-[var(--color-primary)] flex items-center justify-center">
            <Icon name="document" className="w-5 h-5 text-white" aria-hidden={true} client:only="react" />
          </div>
          <span class="font-semibold text-[var(--color-text-primary)]">{siteName}</span>
        </div>
      )}
    </a>
  </div>

  <!-- Products Selector (if products exist) -->
  {hasProducts && (
    <div class="product-selector" data-products={productsJson}>
      {products.map((product, index) => (
        <button
          type="button"
          class:list={[
            'product-btn',
            { 'active': product.id === activeProduct.id }
          ]}
          data-product-id={product.id}
          data-product-folder={product.folder}
          data-product-collection={product.collection}
        >
          {product.icon && (
            <Icon name={getIconName(product.icon)} className="product-icon" aria-hidden={true} client:only="react" />
          )}
          <span class="product-label">{product.label}</span>
        </button>
      ))}
    </div>
  )}

  <!-- Product Navigation (lazy-loaded content area) -->
  {hasProducts && (
    <div class="product-nav-container" id="product-nav-container">
      <div class="product-nav-skeleton">
        <!-- Skeleton folder with children -->
        <div class="skeleton-folder">
          <div class="skeleton-bar skeleton-folder-title"></div>
          <div class="skeleton-children">
            <div class="skeleton-bar skeleton-item"></div>
            <div class="skeleton-bar skeleton-item short"></div>
            <div class="skeleton-bar skeleton-item"></div>
          </div>
        </div>
        <!-- Second skeleton folder -->
        <div class="skeleton-folder">
          <div class="skeleton-bar skeleton-folder-title short"></div>
          <div class="skeleton-children">
            <div class="skeleton-bar skeleton-item"></div>
            <div class="skeleton-bar skeleton-item short"></div>
          </div>
        </div>
        <!-- Third skeleton folder -->
        <div class="skeleton-folder">
          <div class="skeleton-bar skeleton-folder-title"></div>
        </div>
      </div>
      <!-- Content will be loaded dynamically -->
    </div>
  )}

  <!-- Tab Navigation (lazy-loaded content area, controlled by header tabs) -->
  {hasTabs && (
    <div class="tab-nav-container" id="tab-nav-container" data-tabs={tabsJson}>
      <div class="tab-nav-skeleton">
        <!-- Skeleton folder with children -->
        <div class="skeleton-folder">
          <div class="skeleton-bar skeleton-folder-title"></div>
          <div class="skeleton-children">
            <div class="skeleton-bar skeleton-item"></div>
            <div class="skeleton-bar skeleton-item short"></div>
            <div class="skeleton-bar skeleton-item"></div>
          </div>
        </div>
        <!-- Second skeleton folder -->
        <div class="skeleton-folder">
          <div class="skeleton-bar skeleton-folder-title short"></div>
          <div class="skeleton-children">
            <div class="skeleton-bar skeleton-item"></div>
            <div class="skeleton-bar skeleton-item short"></div>
          </div>
        </div>
      </div>
      <!-- Content will be loaded dynamically based on active tab -->
    </div>
  )}

  <!-- Static Navigation (for non-product/tab items or when no products/tabs) -->
  <nav class:list={['sidebar-content', 'scrollbar-on-hover', { 'has-products': hasProducts, 'has-tabs': hasTabs }]}>
    {navigation.length > 0 ? (
      navigation.map((group) => {
        // Check if group has active items or subgroups have active items
        const hasActiveItem = group.items.some(item => item.active);
        const hasActiveSubgroup = group.subgroups?.some(sub =>
          sub.items.some(item => item.active) ||
          sub.subgroups?.some(subsub => subsub.items.some(item => item.active))
        );
        const isExpanded = hasActiveItem || hasActiveSubgroup;

        return (
          <div class="sidebar-nav-group" data-nav-group>
            <button
              type="button"
              class="sidebar-nav-group-title"
              data-nav-toggle
              aria-expanded={isExpanded ? 'true' : 'false'}
            >
              <span class="group-title-content">
                    {group.icon && (
                      <Icon name={getIconName(group.icon)} className="group-title-icon" aria-hidden={true} client:only="react" />
                    )}
                <span class="truncate">{group.title}</span>
              </span>
              <Icon
                name="chevronDown"
                className="nav-chevron"
                style={isExpanded ? { transform: 'rotate(180deg)' } : undefined}
                aria-hidden={true}
                client:only="react"
              />
            </button>
            <div
              class="nav-group-content"
              data-nav-content
              style={isExpanded ? '' : 'display: none;'}
            >
              {/* Direct items in this group */}
              {group.items.length > 0 && (
                <ul>
                  {group.items.map((item) => (
                    <li>
                      <a
                        href={item.href}
                        class:list={['sidebar-nav-item', { active: item.active }]}
                      >
                        {item.icon && (
                          <Icon name={getIconName(item.icon)} className="nav-item-icon" aria-hidden={true} client:only="react" />
                        )}
                        <span class="nav-item-label">{item.label}</span>
                      </a>
                    </li>
                  ))}
                </ul>
              )}

              {/* Nested subgroups */}
              {group.subgroups && group.subgroups.map((subgroup) => {
                const subHasActive = subgroup.items.some(item => item.active);
                return (
                  <div class="sidebar-nav-subgroup" data-nav-group>
                    <button
                      type="button"
                      class="sidebar-nav-subgroup-title"
                      data-nav-toggle
                      aria-expanded={subHasActive ? 'true' : 'false'}
                    >
                      <span class="group-title-content">
                        {subgroup.icon && (
                          <Icon name={getIconName(subgroup.icon)} className="group-title-icon" aria-hidden={true} client:only="react" />
                        )}
                        <span class="truncate">{subgroup.title}</span>
                      </span>
                      <Icon
                        name="chevronDown"
                        className="nav-chevron-sub"
                        style={subHasActive ? { transform: 'rotate(180deg)' } : undefined}
                        aria-hidden={true}
                        client:only="react"
                      />
                    </button>
                    <ul
                      class="nav-subgroup-content"
                      data-nav-content
                      style={subHasActive ? '' : 'display: none;'}
                    >
                      {subgroup.items.map((item) => (
                        <li>
                          <a
                            href={item.href}
                            class:list={['sidebar-nav-item sidebar-nav-item-nested', { active: item.active }]}
                          >
                            {item.icon && (
                              <Icon name={getIconName(item.icon)} className="nav-item-icon" aria-hidden={true} client:only="react" />
                            )}
                            <span class="nav-item-label">{item.label}</span>
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                );
              })}
            </div>
          </div>
        );
      })
    ) : (
      <div class="px-4 py-4 text-sm text-[var(--color-text-muted)]">
        No documents found
      </div>
    )}
  </nav>

  <!-- Footer with language selector and theme toggle (fixed at bottom) -->
  <div class="sidebar-footer">
    <!-- Language Selector (same style as home header) -->
    <div class="sidebar-lang-selector" data-language-selector>
      <button
        class="sidebar-lang-btn"
        data-language-toggle
        aria-expanded="false"
        aria-haspopup="listbox"
        aria-label="Select language"
      >
        <svg class="sidebar-lang-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="10"/><path d="M6 4.71c.78.711 2.388 2.653 2.575 4.737C8.75 11.396 10.035 12.98 12 13c.755.008 1.518-.537 1.516-1.292c0-.233-.039-.472-.099-.692A1.4 1.4 0 0 1 13.5 10c.61-1.257 1.81-1.595 2.76-2.278c.421-.303.806-.623.975-.88c.469-.71.937-2.131.703-2.842M22 13c-.33.931-.562 3.375-4.282 3.414c0 0-3.293 0-4.281 1.862c-.791 1.49-.33 3.103 0 3.724"/>
        </svg>
        <span class="sidebar-lang-code">{currentLocale.toUpperCase()}</span>
        <svg class="sidebar-lang-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 15 12 9 18 15"/>
        </svg>
      </button>
      <div
        class="sidebar-lang-dropdown"
        data-language-dropdown
        data-position="top"
        role="listbox"
        aria-label="Available languages"
      >
        {effectiveTranslations.map(locale => (
          <a
            href={`/${locale}/${currentPath.split('/').filter(Boolean).slice(1).join('/')}`}
            class:list={['sidebar-lang-option', { active: locale === currentLocale }]}
            role="option"
            aria-selected={locale === currentLocale}
            data-locale={locale}
          >
            <span class="sidebar-lang-option-code">{locale.toUpperCase()}</span>
            <span class="sidebar-lang-option-name">{localeNames[locale]}</span>
            {locale === currentLocale && (
              <svg class="sidebar-lang-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            )}
          </a>
        ))}
      </div>
    </div>

    <!-- Theme toggle -->
    <div class="theme-controls">
      <button
        type="button"
        class="theme-btn"
        id="sidebar-theme-toggle"
        aria-label="Toggle dark mode"
      >
        <Icon name="sun" className="theme-icon-light" aria-hidden={true} client:only="react" />
        <Icon name="moon" className="theme-icon-dark" aria-hidden={true} client:only="react" />
      </button>
    </div>
  </div>
</aside>

<script lang="ts">
  const sidebarElement = document.querySelector('.sidebar');
  const sidebarDataset = sidebarElement?.dataset;
  const iconNameMap = sidebarDataset?.iconNameMap
    ? new Map(Object.entries(JSON.parse(sidebarDataset.iconNameMap)))
    : new Map();
  const iconifyMap = sidebarDataset?.iconMap
    ? new Map(Object.entries(JSON.parse(sidebarDataset.iconMap)))
    : new Map();
  const iconSvgCache = new Map();
  const iconSvgRequests = new Map();

  // Icon paths for dynamic rendering (must match server-side iconMap)
  const iconPaths = {
    // Folder icons
    folder: 'M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z',
    'folder-open': 'M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z',
    'folder-tree': 'M3 3v18M13 7h7a2 2 0 012 2v2a2 2 0 01-2 2h-7m0-6v6m0-6l-4-2m4 8l-4 2m4-2h7a2 2 0 012 2v2a2 2 0 01-2 2h-7',
    document: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
    'file-text': 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
    'file-code': 'M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm-1 9l-2 2 2 2m-4-4l2 2-2 2',
    // Technology & Platforms (Mobile/Desktop)
    smartphone: 'M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z',
    'tablet-smartphone': 'M18 8h-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2v-2h2a2 2 0 002-2v-4a2 2 0 00-2-2z',
    tablet: 'M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z',
    monitor: 'M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z',
    laptop: 'M12 18h.01M21 16V5a2 2 0 00-2-2H5a2 2 0 00-2 2v11m18 0H3m18 0l1.5 3H1.5L3 16',
    tv: 'M4 7h16a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V9a2 2 0 012-2zm4-4h8',
    watch: 'M12 8v4l2 2m-6 6h8a2 2 0 002-2V6a2 2 0 00-2-2H8a2 2 0 00-2 2v12a2 2 0 002 2z',
    // Brand/Platform icons (simplified representations)
    apple: 'M12 2C9.243 2 7 4.243 7 7v1H6a2 2 0 00-2 2v9a2 2 0 002 2h12a2 2 0 002-2v-9a2 2 0 00-2-2h-1V7c0-2.757-2.243-5-5-5zm0 2c1.654 0 3 1.346 3 3v1H9V7c0-1.654 1.346-3 3-3z',
    android: 'M5 16v-4a7 7 0 0114 0v4M4 11h1m14 0h1M8 16v3m8-3v3M8 3l1 2m6-2l-1 2',
    windows: 'M3 5l7-1v7H3V5zm0 14l7 1v-7H3v6zm8 1l10 1.5V12h-10v8zm0-18v8h10V3.5L11 2z',
    chrome: 'M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-6a4 4 0 100-8 4 4 0 000 8z',
    github: 'M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.166 6.839 9.489.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.604-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.268 2.75 1.026A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.026 2.747-1.026.546 1.377.202 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.163 22 16.418 22 12c0-5.523-4.477-10-10-10z',
    gitlab: 'M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 01-.3-.94l1.22-3.78 2.44-7.51a.42.42 0 01.82 0l2.44 7.51h8.06l2.44-7.51a.42.42 0 01.82 0l2.44 7.51 1.22 3.78a.84.84 0 01-.3.94z',
    figma: 'M5 5.5A3.5 3.5 0 018.5 2H12v7H8.5A3.5 3.5 0 015 5.5zM12 2h3.5a3.5 3.5 0 110 7H12V2zm0 7v7h3.5a3.5 3.5 0 100-7H12zm-3.5 7a3.5 3.5 0 100-7H12v7H8.5zm0 7A3.5 3.5 0 018.5 16H12v3.5a3.5 3.5 0 01-3.5 3.5z',
    slack: 'M14.5 10c-.83 0-1.5-.67-1.5-1.5v-5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5zm6 0H19v-1.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm-11 4c.83 0 1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5S8 21.33 8 20.5v-5c0-.83.67-1.5 1.5-1.5zm-6 0H5v1.5c0 .83-.67 1.5-1.5 1.5S2 16.33 2 15.5 2.67 14 3.5 14z',
    // Infrastructure
    server: 'M5 12H3a2 2 0 00-2 2v4a2 2 0 002 2h2m16-8h2a2 2 0 012 2v4a2 2 0 01-2 2h-2M5 8h14a2 2 0 002-2V4a2 2 0 00-2-2H5a2 2 0 00-2 2v2a2 2 0 002 2z M5 20h14a2 2 0 002-2v-2a2 2 0 00-2-2H5a2 2 0 00-2 2v2a2 2 0 002 2z',
    cloud: 'M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z',
    database: 'M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4',
    cpu: 'M9 3v2m6-2v2M9 19v2m6-2v2M3 9h2m-2 6h2m14-6h2m-2 6h2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z',
    'hard-drive': 'M22 12H2m20 0a2 2 0 01-2 2H4a2 2 0 01-2-2m20 0a2 2 0 00-2-2H4a2 2 0 00-2 2m18 2v4a2 2 0 01-2 2H6a2 2 0 01-2-2v-4m16-6V6a2 2 0 00-2-2H6a2 2 0 00-2 2v4',
    'memory-stick': 'M6 19v-8a2 2 0 012-2h8a2 2 0 012 2v8M6 19h12M6 19H4a2 2 0 01-2-2v-4a2 2 0 012-2h2m12 8h2a2 2 0 002-2v-4a2 2 0 00-2-2h-2M9 13v2m3-2v2m3-2v2',
    'circuit-board': 'M12 2v4m0 12v4M2 12h4m12 0h4m-4-6l2-2m-2 16l2 2M4 4l2 2M4 20l2-2m12-6a4 4 0 11-8 0 4 4 0 018 0z',
    wifi: 'M5 12.55a11 11 0 0114.08 0M1.42 9a16 16 0 0121.16 0M8.53 16.11a6 6 0 016.95 0M12 20h.01',
    bluetooth: 'M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11',
    // Security
    shield: 'M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z',
    'shield-check': 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z',
    'shield-alert': 'M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10zM12 8v4m0 4h.01',
    lock: 'M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z',
    'lock-open': 'M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z',
    key: 'M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z',
    'key-round': 'M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 10-4-4L2 18zM16.5 9a1.5 1.5 0 100-3 1.5 1.5 0 000 3z',
    fingerprint: 'M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4',
    scan: 'M3 7V5a2 2 0 012-2h2M17 3h2a2 2 0 012 2v2M21 17v2a2 2 0 01-2 2h-2M7 21H5a2 2 0 01-2-2v-2',
    'scan-face': 'M3 7V5a2 2 0 012-2h2M17 3h2a2 2 0 012 2v2M21 17v2a2 2 0 01-2 2h-2M7 21H5a2 2 0 01-2-2v-2m5-7a2 2 0 104 0 2 2 0 00-4 0zm6 0a2 2 0 104 0 2 2 0 00-4 0z',
    eye: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z',
    'eye-off': 'M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24M1 1l22 22',
    // Development & API
    code: 'M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4',
    'code-2': 'M16 18l6-6-6-6M8 6l-6 6 6 6',
    terminal: 'M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z',
    'terminal-square': 'M7 11l2.5 2.5L7 16m4 0h4m4 4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v12a2 2 0 01-2 2z',
    'git-branch': 'M6 3v12M18 9a3 3 0 100-6 3 3 0 000 6zM6 21a3 3 0 100-6 3 3 0 000 6zM18 9a9 9 0 01-9 9',
    'git-commit': 'M12 16a4 4 0 100-8 4 4 0 000 8zm-9-4h5m4 0h9',
    'git-merge': 'M18 21a3 3 0 100-6 3 3 0 000 6zM6 9a3 3 0 100-6 3 3 0 000 6zM6 21V9m0 0a9 9 0 009 9',
    'git-pull-request': 'M18 21a3 3 0 100-6 3 3 0 000 6zM6 9a3 3 0 100-6 3 3 0 000 6zM6 21V9m12 3V9a3 3 0 00-3-3h-4',
    webhook: 'M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71',
    api: 'M4 6h16M4 12h16M4 18h8m4-9v6m3-3h-6',
    braces: 'M8 3H7a2 2 0 00-2 2v5a2 2 0 01-2 2 2 2 0 012 2v5a2 2 0 002 2h1m8 0h1a2 2 0 002-2v-5a2 2 0 012-2 2 2 0 01-2-2V5a2 2 0 00-2-2h-1',
    brackets: 'M16 3h3v18h-3M8 3H5v18h3',
    binary: 'M6 20h4m-2-4v4M6 14h4m-2-2v6M14 6h4m-4 0v6m4-6v6m-4 2h4m-2-2v10',
    bug: 'M8 2l1.88 1.88M14.12 3.88L16 2M9 7.13v-1a3.003 3.003 0 116 0v1m-9 6a6 6 0 0012 0v-3M3 13h18M12 20v-3M9 20h6M5 8h14M5 16h14',
    'test-tube': 'M9 3h6m-5 0v10a7 7 0 007 7 7 7 0 007-7V3m-14 0v10a7 7 0 007 7',
    'flask-conical': 'M10 2v7.31M14 2v7.31m-8 4.69h12l-2 8H6l-2-8zm6-5a5 5 0 015 5',
    // Integrations & Plugins
    plug: 'M12 2v6m0 0V2m0 6c-2 0-3 1-3 3m3-3c2 0 3 1 3 3m-6 0H5m1 0c0 2 1 3 3 3v6c0 1 1 2 3 2s3-1 3-2v-6c2 0 3-1 3-3m0 0h1',
    'plug-2': 'M9 2v6m6-6v6M3 14h18M7 14l.8-5H4a1 1 0 00-1 1v3a1 1 0 001 1zm10.2-5l.8 5h3a1 1 0 001-1v-3a1 1 0 00-1-1zM12 22v-8',
    unplug: 'M19 5l-2 2M2 22l5.5-5.5m.5-2.5l-2.5 2.5m9-9L12 10m3-7l2 2m-8 8l4-4m6 6l-4 4M7 17l4-4',
    puzzle: 'M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z',
    blocks: 'M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4',
    component: 'M5.5 8.5L9 12l-3.5 3.5L2 12l3.5-3.5zM12 2l3.5 3.5L12 9 8.5 5.5 12 2zm0 13l3.5 3.5L12 22l-3.5-3.5L12 15zm6.5-6.5L22 12l-3.5 3.5L15 12l3.5-3.5z',
    package: 'M16.5 9.4l-9-5.19M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12',
    'package-open': 'M20.91 8.84l-8.17 4.7a1 1 0 01-1 0L3.5 8.84m8.41-5.78l7.73 4.46a1 1 0 01.5.87v7.72a1 1 0 01-.5.87l-7.73 4.45a1 1 0 01-1 0L3.18 17a1 1 0 01-.5-.87V8.39a1 1 0 01.5-.87l7.73-4.46a1 1 0 011 0zM12 12v10',
    box: 'M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z',
    boxes: 'M2.97 12.92A2 2 0 002 14.63v3.24a2 2 0 001.02 1.75l3.5 2a2 2 0 002 0l3.5-2a2 2 0 001.02-1.75v-3.24a2 2 0 00-.97-1.71L8.5 10.86a2 2 0 00-2 0l-3.53 2.06zM14 12.92a2 2 0 00-1.02 1.71v3.24a2 2 0 001.02 1.75l3.5 2a2 2 0 002 0l3.5-2a2 2 0 001.02-1.75v-3.24a2 2 0 00-.97-1.71l-3.53-2.06a2 2 0 00-2 0l-3.52 2.06zM8.5 5.86l3.5-2a2 2 0 012 0l3.5 2A2 2 0 0118.5 7.6v3.24a2 2 0 01-1.02 1.75l-3.5 2a2 2 0 01-2 0l-3.5-2a2 2 0 01-1-1.75V7.6a2 2 0 011.02-1.74z',
    layers: 'M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5',
    'layers-2': 'M12 16l-6-3.2V8.5L12 5l6 3.5v4.3L12 16zM6 12.8L12 16l6-3.2m-12 3.7l6 3.2 6-3.2',
    // Documentation
    book: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253',
    'book-open': 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253',
    'book-marked': 'M4 19.5A2.5 2.5 0 016.5 17H20M4 19.5A2.5 2.5 0 006.5 22H20V2H6.5A2.5 2.5 0 004 4.5v15zM10 2v8l3-2 3 2V2',
    scroll: 'M8 21h12a2 2 0 002-2v-2H10v2a2 2 0 11-4 0V5a2 2 0 10-4 0v3h4',
    notebook: 'M4 19.5A2.5 2.5 0 016.5 17H20M4 4.5A2.5 2.5 0 016.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15z',
    clipboard: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2',
    'clipboard-list': 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4',
    // Navigation & Settings
    settings: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z',
    'settings-2': 'M20 7h-9m9 10h-9M4 7h.01M4 17h.01M7 7a3 3 0 106 0 3 3 0 00-6 0zm10 10a3 3 0 106 0 3 3 0 00-6 0z',
    home: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6',
    compass: 'M22 12h-4l-3 9L9 3l-3 9H2',
    map: 'M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7',
    'map-pin': 'M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0zm-9 3a3 3 0 100-6 3 3 0 000 6z',
    bookmark: 'M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z',
    menu: 'M4 6h16M4 12h16M4 18h16',
    'panel-left': 'M3 3h18v18H3V3zm6 0v18',
    'layout-dashboard': 'M3 3h7v9H3V3zm11 0h7v5h-7V3zM3 15h7v6H3v-6zm11-3h7v9h-7v-9z',
    'layout-grid': 'M3 3h7v7H3V3zm11 0h7v7h-7V3zM3 14h7v7H3v-7zm11 0h7v7h-7v-7z',
    'layout-list': 'M3 5h18M3 10h18M3 15h18M3 20h18',
    wrench: 'M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z',
    cog: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z',
    sliders: 'M4 21v-7m0-4V3m8 18v-9m0-4V3m8 18v-5m0-4V3M1 14h6m2-6h6m2 8h6',
    'sliders-horizontal': 'M21 4H3m0 0l6 6m-6-6l6-6M3 20h18m0 0l-6-6m6 6l-6 6',
    // Actions
    zap: 'M13 2L3 14h9l-1 8 10-12h-9l1-8z',
    'zap-off': 'M12.41 6.75L13 2l-2.43 2.92m4.02 9.22L10 19l.59-4.14m5.17-4.44l6.19-8.63-8.95 5.25M3.41 15.75L12 7l-2.23-1.31M3 3l18 18',
    rocket: 'M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91-.79-.78-2.07-.79-2.91-.09zm9.24-10.24L12 4.5C8.5 1 3.68 1.94 2.5 2.5c-.56 1.18-1.5 6 2 9.5l1.75-1.75m10.01-4.01C17.5 5 19 4.5 21 4c-.5 2-1 3.5-2.25 4.75M15 9l-3 3m3.89-8.89c.93-.93 1.96-1.54 3.11-1.61 1.15-.07 3 .77 3 .77s.84 1.85.77 3c-.07 1.15-.68 2.18-1.61 3.11l-8.54 8.54-5.66-5.66 8.93-8.15z',
    play: 'M5 3l14 9-14 9V3z',
    download: 'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4',
    upload: 'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12',
    'refresh-cw': 'M1 4v6h6M23 20v-6h-6m-.02-5.02A9 9 0 006.67 6.34L1 10m22 4l-5.67 3.66A9 9 0 016.05 15.02',
    trash: 'M3 6h18m-2 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2',
    pencil: 'M17 3a2.828 2.828 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z',
    plus: 'M12 5v14m-7-7h14',
    // Users & Org
    user: 'M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2m8-10a4 4 0 100-8 4 4 0 000 8z',
    'user-check': 'M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2m22-5l-4 4-2-2M12.5 7a4 4 0 11-8 0 4 4 0 018 0z',
    users: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z',
    building: 'M3 21h18M9 21v-4a2 2 0 012-2h2a2 2 0 012 2v4M3 7l9-4 9 4M4 10h16v11H4V10z',
    'building-2': 'M6 22V4a2 2 0 012-2h8a2 2 0 012 2v18M2 22h20M6 12h.01M10 12h.01M14 12h.01M6 16h.01M10 16h.01M14 16h.01M6 8h.01M10 8h.01M14 8h.01',
    briefcase: 'M20 7H4a2 2 0 00-2 2v10a2 2 0 002 2h16a2 2 0 002-2V9a2 2 0 00-2-2zm-6 0V5a2 2 0 00-2-2h-2a2 2 0 00-2 2v2',
    'id-card': 'M4 4h16a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm4 10a2 2 0 100-4 2 2 0 000 4zm6-4h4m-4 4h4M4 16h16',
    // Communication
    bell: 'M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0',
    'bell-ring': 'M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9m-8.27 13a2 2 0 003.46 0M2 2c.42.42 1.29 1.29 1.29 1.29m18.42-1.29L20.42 3.29',
    mail: 'M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z',
    'message-square': 'M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2v10z',
    'message-circle': 'M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z',
    phone: 'M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z',
    video: 'M23 7l-7 5 7 5V7zM14 5H3a2 2 0 00-2 2v10a2 2 0 002 2h11a2 2 0 002-2V7a2 2 0 00-2-2z',
    'help-circle': 'M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z',
    // Analytics
    'bar-chart': 'M18 20V10m-6 10V4M6 20v-6',
    'bar-chart-2': 'M18 20V10m-6 10V4M6 20v-6',
    'line-chart': 'M3 3v18h18M7 14l4-4 4 4 5-5',
    'pie-chart': 'M21.21 15.89A10 10 0 118 2.83M22 12A10 10 0 0012 2v10z',
    'trending-up': 'M22 7l-8.5 8.5-5-5L2 17',
    'trending-down': 'M22 17l-8.5-8.5-5 5L2 7',
    activity: 'M22 12h-4l-3 9L9 3l-3 9H2',
    // Misc & Status
    star: 'M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z',
    heart: 'M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z',
    flag: 'M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1v12zm0 7v-7',
    tag: 'M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z',
    tags: 'M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z M6 6h.01',
    globe: 'M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9',
    'globe-2': 'M12 2a10 10 0 100 20 10 10 0 000-20zm0 2a8 8 0 017.938 7H4.062A8 8 0 0112 4zm0 16a8 8 0 01-7.938-7h15.876A8 8 0 0112 20z',
    link: 'M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71',
    'link-2': 'M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3m-1 5h8',
    'external-link': 'M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6m4-3h6v6m-11 5L21 3',
    check: 'M5 13l4 4L19 7',
    'check-circle': 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z',
    x: 'M18 6L6 18M6 6l12 12',
    'x-circle': 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z',
    'alert-triangle': 'M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4m0 4h.01',
    info: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z',
  };

  // Cache for loaded folder content
  const folderCache = new Map();

  // Get current locale from page or default to 'en'
  function getCurrentLocale() {
    // Try to get from URL path (e.g., /en/docs/... or /es/docs/...)
    const pathParts = window.location.pathname.split('/').filter(Boolean);
    const knownLocales = ['en', 'es', 'fr', 'de', 'pt', 'it', 'ja', 'zh', 'ko'];
    for (const part of pathParts) {
      if (knownLocales.includes(part)) {
        return part;
      }
    }
    // Try to get from language selector
    const langBtn = document.querySelector('.sidebar-lang-code');
    if (langBtn) {
      const code = langBtn.textContent?.trim().toUpperCase();
      if (code && knownLocales.includes(code.toLowerCase())) {
        return code.toLowerCase();
      }
    }
    return 'en';
  }

  // Fetch folder content from CMS API
  async function fetchFolderContent(collection, folder) {
    const locale = getCurrentLocale();
    const cacheKey = `${collection}/${folder}/${locale}`;
    const cached = folderCache.get(cacheKey);
    if (cached) {
      return cached;
    }

    try {
      // Use CMS API directly (server-rendered endpoint, works with static builds)
      const sidebar = document.querySelector('.sidebar');
      const cmsUrl = sidebar?.dataset?.cmsUrl || '';
      const apiUrl = cmsUrl
        ? `${cmsUrl}/api/docs/navigation?collection=${collection}&folder=${folder}&locale=${locale}`
        : `/api/navigation?collection=${collection}&folder=${folder}&locale=${locale}`;
      const response = await fetch(apiUrl);
      if (!response.ok) throw new Error('Failed to fetch');
      const data = await response.json();
      const items = data.items || [];
      folderCache.set(cacheKey, items);
      return items;
    } catch (error) {
      console.error('Failed to fetch folder content:', error);
      return [];
    }
  }

  // Format title from path segment
  function formatTitle(segment) {
    return segment
      .replace(/-/g, ' ')
      .replace(/_/g, ' ')
      .replace(/\b\w/g, c => c.toUpperCase());
  }

  function resolveIconName(iconName, isFolder = false) {
    if (!iconName) return isFolder ? 'folder' : 'document';
    const normalized = iconName.toLowerCase();
    return iconNameMap.get(normalized) || (isFolder ? 'folder' : 'document');
  }

  function resolveIconifyName(iconName, isFolder = false) {
    const resolved = resolveIconName(iconName, isFolder);
    return iconifyMap.get(resolved) || iconifyMap.get(isFolder ? 'folder' : 'document') || '';
  }

  function renderIcon(iconName, className = '', isFolder = false) {
    const iconifyName = resolveIconifyName(iconName, isFolder);
    if (!iconifyName) return '';
    return `<span class="${className}" data-iconify="${iconifyName}"></span>`;
  }

  function renderIconByName(iconifyName, className = '', style = '') {
    if (!iconifyName) return '';
    const styleAttr = style ? ` style="${style}"` : '';
    return `<span class="${className}" data-iconify="${iconifyName}"${styleAttr}></span>`;
  }

  async function loadIconSvg(iconifyName) {
    const cached = iconSvgCache.get(iconifyName);
    if (cached) return cached;
    const inFlight = iconSvgRequests.get(iconifyName);
    if (inFlight) return inFlight;
    const request = fetch(`https://api.iconify.design/${iconifyName}.svg`)
      .then(res => (res.ok ? res.text() : ''))
      .then(svg => {
        iconSvgCache.set(iconifyName, svg);
        return svg;
      })
      .catch(() => '');
    iconSvgRequests.set(iconifyName, request);
    return request;
  }

  async function hydrateIcons(container) {
    const placeholders = Array.from(container.querySelectorAll('[data-iconify]'));
    if (placeholders.length === 0) return;
    await Promise.all(placeholders.map(async placeholder => {
      const iconifyName = placeholder.dataset?.iconify;
      if (!iconifyName) return;
      const svg = await loadIconSvg(iconifyName);
      if (!svg) return;
      placeholder.innerHTML = svg;
    }));
  }

  // Check if any item or its descendants are active (recursive)
  function hasActiveDescendant(items, currentPath) {
    for (const item of items) {
      if (currentPath === item.href || currentPath.startsWith(item.href + '/')) {
        return true;
      }
      if (item.children && hasActiveDescendant(item.children, currentPath)) {
        return true;
      }
    }
    return false;
  }

  // Render folder navigation tree
  function renderFolderTree(items, currentPath, depth = 0) {
    if (!items || items.length === 0) return '';

    return items.map(item => {
      const isActive = currentPath === item.href || currentPath.startsWith(item.href + '/');
      const isFolder = item.type === 'folder';
      const paddingLeft = 0.75 + (depth * 0.75);

      if (isFolder && item.children) {
        // Check recursively for active items in all descendants
        const hasActiveChild = hasActiveDescendant(item.children, currentPath);
        const chevronStyle = hasActiveChild ? 'transform: rotate(180deg)' : '';
        const chevronIcon = iconifyMap.get('chevronDown') || '';

        return `
          <div class="folder-group" data-folder-group>
            <button
              type="button"
              class="folder-toggle ${hasActiveChild ? 'has-active' : ''}"
              data-folder-toggle
              aria-expanded="${hasActiveChild ? 'true' : 'false'}"
              style="padding-left: ${paddingLeft}rem"
            >
              ${renderIcon(item.icon, 'folder-icon', true)}
              <span class="folder-label">${item.title || formatTitle(item.name)}</span>
              ${renderIconByName(chevronIcon, 'folder-chevron', chevronStyle)}
            </button>
            <div class="folder-content" data-folder-content style="${hasActiveChild ? '' : 'display: none'}">
              ${renderFolderTree(item.children, currentPath, depth + 1)}
            </div>
          </div>
        `;
      } else {
        return `
          <a
            href="${item.href}"
            class="folder-item ${isActive ? 'active' : ''}"
            style="padding-left: ${paddingLeft}rem"
          >
            ${renderIcon(item.icon, 'folder-item-icon', false)}
            <span class="folder-item-label">${item.title || formatTitle(item.name)}</span>
          </a>
        `;
      }
    }).join('');
  }

  // Initialize folder toggle handlers
  function initFolderToggles(container) {
    const folderGroups = container.querySelectorAll('[data-folder-group]');
    folderGroups.forEach(group => {
      const toggle = group.querySelector('[data-folder-toggle]');
      const content = group.querySelector('[data-folder-content]');
      const chevron = toggle?.querySelector('.folder-chevron');

      if (!toggle || !content) return;

      toggle.addEventListener('click', () => {
        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
        toggle.setAttribute('aria-expanded', (!isExpanded).toString());
        if (chevron) {
          chevron.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
        }
        content.style.display = isExpanded ? 'none' : 'block';
      });
    });
  }

  // Load product navigation
  async function loadProductNav(productBtn) {
    const container = document.getElementById('product-nav-container');
    if (!container) return;

    const folder = productBtn.dataset.productFolder;
    const collection = productBtn.dataset.productCollection || 'docs';

    if (!folder) {
      container.innerHTML = '<div class="product-nav-empty">No folder configured for this product</div>';
      return;
    }

    // Show skeleton loading
    container.innerHTML = `
      <div class="product-nav-skeleton">
        <div class="skeleton-folder">
          <div class="skeleton-bar skeleton-folder-title"></div>
          <div class="skeleton-children">
            <div class="skeleton-bar skeleton-item"></div>
            <div class="skeleton-bar skeleton-item short"></div>
            <div class="skeleton-bar skeleton-item"></div>
          </div>
        </div>
        <div class="skeleton-folder">
          <div class="skeleton-bar skeleton-folder-title short"></div>
          <div class="skeleton-children">
            <div class="skeleton-bar skeleton-item"></div>
            <div class="skeleton-bar skeleton-item short"></div>
          </div>
        </div>
      </div>
    `;

    // Fetch content
    const items = await fetchFolderContent(collection, folder);
    const currentPath = window.location.pathname;

    if (items.length === 0) {
      container.innerHTML = '<div class="product-nav-empty">No content found</div>';
      return;
    }

    // Render navigation
    container.innerHTML = `<div class="product-nav-content">${renderFolderTree(items, currentPath)}</div>`;

    // Initialize toggle handlers
    initFolderToggles(container);

    // Hydrate iconify placeholders with actual SVGs
    await hydrateIcons(container);
  }

  /**
   * Load tab navigation content
   * - Aborts previous request if new one comes in (prevents race conditions)
   * - Uses cache for instant re-renders of visited tabs
   * - Minimal DOM updates
   */
  let currentLoadController = null;

  async function loadTabNav(folder, collection) {
    const container = document.getElementById('tab-nav-container');
    if (!container || !folder) return;

    // Abort any in-flight request
    currentLoadController?.abort();
    currentLoadController = new AbortController();

    // Check cache first for instant render
    const locale = getCurrentLocale();
    const cacheKey = `${collection}/${folder}/${locale}`;
    const cached = folderCache.get(cacheKey);

    if (cached) {
      renderNav(container, cached);
      return;
    }

    // Show minimal loading indicator
    container.setAttribute('aria-busy', 'true');

    try {
      const items = await fetchFolderContent(collection, folder);
      renderNav(container, items);
    } catch (e) {
      const isAbort =
        e &&
        typeof e === 'object' &&
        'name' in e &&
        e.name === 'AbortError';
      if (!isAbort) {
        container.innerHTML = '<div class="tab-nav-empty">Failed to load</div>';
      }
    } finally {
      container.removeAttribute('aria-busy');
    }
  }

  function renderNav(container, items) {
    if (items.length === 0) {
      container.innerHTML = '<div class="tab-nav-empty">No content found</div>';
      return;
    }
    container.innerHTML = `<div class="tab-nav-content">${renderFolderTree(items, location.pathname)}</div>`;
    initFolderToggles(container);

    // Hydrate iconify placeholders with actual SVGs
    hydrateIcons(container);
  }

  function initSidebar() {
    // Product selector
    const productBtns = document.querySelectorAll('.product-btn');
    productBtns.forEach(btn => {
      btn.addEventListener('click', async () => {
        // Update active state
        productBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Load product navigation
        await loadProductNav(btn);
      });
    });

    // Load default active product navigation on page load
    const activeProduct = document.querySelector('.product-btn.active');
    if (activeProduct) {
      loadProductNav(activeProduct);
    }

    // Tab navigation - listen for tabChange events from header
    const tabContainer = document.getElementById('tab-nav-container');
    if (tabContainer) {
      // Load initial tab content from localStorage or default
      const storedTab = localStorage.getItem('docs_active_tab');
      let initialTab = null;

      if (storedTab) {
        try {
          initialTab = JSON.parse(storedTab);
        } catch (e) {
          // Ignore parse errors
        }
      }

      // If no stored tab, use default from data attribute
      if (!initialTab) {
        const tabsData = tabContainer.dataset.tabs;
        if (tabsData) {
          try {
            const tabs = JSON.parse(tabsData);
            const defaultTab = tabs.find((t) => t.defaultActive) || tabs[0];
            if (defaultTab) {
              initialTab = {
                id: defaultTab.id,
                folder: defaultTab.folder,
                collection: defaultTab.collection || 'docs'
              };
            }
          } catch (e) {
            // Ignore parse errors
          }
        }
      }

      // Load initial tab navigation
      if (initialTab?.folder) {
        loadTabNav(initialTab.folder, initialTab.collection);
      }

      // Listen for tab changes from header
      window.addEventListener('tabChange', (e) => {
        const detail = e.detail || {};
        const { folder, collection } = detail || {};
        if (folder) loadTabNav(folder, collection);
      });
    }

    // Navigation toggle (for static navigation)
    const groups = document.querySelectorAll('[data-nav-group]');
    groups.forEach(group => {
      const toggle = group.querySelector('[data-nav-toggle]');
    const content = group.querySelector('[data-nav-content]');
    const chevron = toggle?.querySelector('.nav-chevron, .nav-chevron-sub');

      if (!toggle || !content) return;

      toggle.addEventListener('click', () => {
        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
        toggle.setAttribute('aria-expanded', (!isExpanded).toString());
        if (chevron) {
          chevron.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
        }
        content.style.display = isExpanded ? 'none' : 'block';
      });
    });

    // Language selector
    const langSelector = document.querySelector('[data-language-selector]');
    const langToggle = langSelector?.querySelector('[data-language-toggle]');
    const langDropdown = langSelector?.querySelector('[data-language-dropdown]');

    if (langToggle && langDropdown && langSelector) {
      langToggle.addEventListener('click', () => {
        const isOpen = langToggle.getAttribute('aria-expanded') === 'true';
        langToggle.setAttribute('aria-expanded', (!isOpen).toString());
        langSelector.classList.toggle('open', !isOpen);
      });

      // Close on click outside
      document.addEventListener('click', (e) => {
        if (e.target && !langSelector.contains(e.target)) {
          langToggle.setAttribute('aria-expanded', 'false');
          langSelector.classList.remove('open');
        }
      });
    }

    // Theme toggle
    const themeToggle = document.getElementById('sidebar-theme-toggle');
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });
    }
  }

  // Run on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSidebar);
  } else {
    initSidebar();
  }
  document.addEventListener('astro:after-swap', initSidebar);
</script>

<style>
  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    width: var(--sidebar-width);
    background: transparent;
    border: none;
    z-index: 40;
    display: flex;
    flex-direction: column;
    overflow: visible;
    transition: transform 0.3s ease;
  }

  .sidebar-header {
    height: var(--header-height);
    display: flex;
    align-items: center;
    padding: 0 1.25rem;
    flex-shrink: 0;
  }

  .sidebar-logo {
    display: flex;
    align-items: center;
  }

  /* Product Selector */
  .product-selector {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    padding: 0 1rem 0.75rem;
    border-bottom: 1px solid var(--color-border);
  }

  .product-btn {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    background: transparent;
    border: 1px solid transparent;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.15s ease;
    text-align: left;
  }

  .product-btn:hover {
    color: var(--color-menu-item-hover-text);
    background: var(--color-menu-item-hover-bg);
  }

  .product-btn.active {
    color: var(--color-menu-item-active-text, var(--color-primary));
    background: var(--color-menu-item-active-bg, var(--color-primary-10));
    border-color: var(--color-border);
  }

  :global(.dark) .product-btn.active {
    color: var(--color-menu-item-active-text, var(--color-accent-light));
    background: var(--color-menu-item-active-bg, var(--color-accent-10));
    border-color: var(--color-border);
  }

  .product-icon {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
    opacity: 0.7;
  }

  .product-btn.active .product-icon {
    opacity: 1;
  }

  .product-label {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Product Navigation Container */
  .product-nav-container {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem 0.75rem;
    scrollbar-width: thin;
    scrollbar-color: transparent transparent;
  }

  .product-nav-container::-webkit-scrollbar {
    width: 6px;
  }

  .product-nav-container::-webkit-scrollbar-track {
    background: transparent;
  }

  .product-nav-container::-webkit-scrollbar-thumb {
    background-color: transparent;
    border-radius: 9999px;
  }

  .product-nav-container:hover {
    scrollbar-color: var(--color-border) transparent;
  }

  .product-nav-container:hover::-webkit-scrollbar-thumb {
    background-color: var(--color-border);
  }

  /* Skeleton Loading Styles */
  .product-nav-skeleton,
  .tab-nav-skeleton,
  :global(.product-nav-skeleton),
  :global(.tab-nav-skeleton) {
    padding: 0.75rem;
  }

  .skeleton-folder {
    margin-bottom: 0.75rem;
  }

  .skeleton-bar {
    height: 0.625rem;
    border-radius: 0.25rem;
    background: linear-gradient(
      90deg,
      var(--color-border) 0%,
      var(--color-background-secondary) 50%,
      var(--color-border) 100%
    );
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s ease-in-out infinite;
  }

  .skeleton-folder-title {
    width: 60%;
    height: 0.75rem;
    margin-bottom: 0.5rem;
    margin-left: 0.25rem;
  }

  .skeleton-folder-title.short {
    width: 45%;
  }

  .skeleton-children {
    padding-left: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .skeleton-item {
    width: 80%;
  }

  .skeleton-item.short {
    width: 55%;
  }

  @keyframes skeleton-shimmer {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  .product-nav-empty,
  :global(.product-nav-empty) {
    padding: 1.5rem 1rem;
    text-align: center;
    color: var(--color-text-muted);
    font-size: 0.8125rem;
  }

  :global(.product-nav-content) {
    display: flex;
    flex-direction: column;
  }

  /* Folder Tree Styles - must be global for dynamic JS rendering */
  :global(.folder-group) {
    margin-bottom: 0.125rem;
  }

  :global(.folder-toggle) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
    padding-right: 0.75rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    background: transparent;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    text-align: left;
    transition: all 0.15s ease;
  }

  :global(.folder-toggle:hover) {
    color: var(--color-menu-item-hover-text);
    background: var(--color-menu-item-hover-bg);
  }

  :global(.folder-toggle.has-active) {
    color: var(--color-text-primary);
  }

  :global(.folder-icon) {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
    color: var(--color-text-muted);
  }

  :global(.folder-toggle:hover .folder-icon),
  :global(.folder-toggle.has-active .folder-icon) {
    color: var(--color-primary);
  }

  :global(.folder-label) {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  :global(.folder-chevron) {
    width: 0.875rem;
    height: 0.875rem;
    opacity: 0.4;
    transition: transform 0.2s ease, opacity 0.15s ease;
    flex-shrink: 0;
  }

  :global(.folder-toggle:hover .folder-chevron) {
    opacity: 0.7;
  }

  :global(.folder-content) {
    overflow: hidden;
  }

  :global(.folder-item) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
    padding-right: 0.75rem;
    font-size: 0.8125rem;
    color: var(--color-text-tertiary);
    border-radius: 0.375rem;
    transition: all 0.15s ease;
    text-decoration: none;
  }

  :global(.folder-item:hover) {
    color: var(--color-menu-item-hover-text);
    background: var(--color-menu-item-hover-bg);
  }

  :global(.folder-item.active) {
    color: var(--color-menu-item-active-text, var(--color-primary));
    background: var(--color-menu-item-active-bg, var(--color-primary-10));
    font-weight: 500;
  }

  :global(.dark .folder-item.active) {
    color: var(--color-menu-item-active-text, var(--color-accent-light));
    background: var(--color-menu-item-active-bg, var(--color-accent-10));
  }

  :global(.folder-item-icon) {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
    opacity: 0.5;
  }

  :global(.folder-item:hover .folder-item-icon),
  :global(.folder-item.active .folder-item-icon) {
    opacity: 1;
  }

  :global(.folder-item-label) {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Hide static content when products or tabs are active */
  .sidebar-content.has-products,
  .sidebar-content.has-tabs {
    display: none;
  }

  /* Tab Navigation Container */
  .tab-nav-container {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
    scrollbar-width: thin;
    scrollbar-color: transparent transparent;
  }

  .tab-nav-container::-webkit-scrollbar {
    width: 6px;
  }

  .tab-nav-container::-webkit-scrollbar-track {
    background: transparent;
  }

  .tab-nav-container::-webkit-scrollbar-thumb {
    background-color: transparent;
    border-radius: 9999px;
  }

  .tab-nav-container:hover {
    scrollbar-color: var(--color-border) transparent;
  }

  .tab-nav-container:hover::-webkit-scrollbar-thumb {
    background-color: var(--color-border);
  }

  .tab-nav-empty,
  :global(.tab-nav-empty) {
    padding: 1.5rem 1rem;
    text-align: center;
    color: var(--color-text-muted);
    font-size: 0.8125rem;
  }

  :global(.tab-nav-content) {
    display: flex;
    flex-direction: column;
  }

  .sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
    scrollbar-width: thin;
    scrollbar-color: transparent transparent;
  }

  .sidebar-content::-webkit-scrollbar {
    width: 6px;
  }

  .sidebar-content::-webkit-scrollbar-track {
    background: transparent;
  }

  .sidebar-content::-webkit-scrollbar-thumb {
    background-color: transparent;
    border-radius: 9999px;
  }

  .sidebar-content:hover {
    scrollbar-color: var(--color-border) transparent;
  }

  .sidebar-content:hover::-webkit-scrollbar-thumb {
    background-color: var(--color-border);
  }

  .sidebar-nav-group {
    margin-bottom: 0.5rem;
  }

  .sidebar-nav-group-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    background: transparent;
    border: none;
    cursor: pointer;
    border-radius: 0.375rem;
    transition: all 0.15s ease;
  }

  .sidebar-nav-group-title:hover {
    color: var(--color-menu-item-hover-text);
    background-color: var(--color-menu-item-hover-bg);
  }

  .group-title-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    min-width: 0;
  }

  .group-title-icon {
    width: 0.875rem;
    height: 0.875rem;
    flex-shrink: 0;
    opacity: 0.6;
  }

  .sidebar-nav-group-title:hover .group-title-icon {
    opacity: 1;
  }

  .nav-chevron {
    width: 0.875rem;
    height: 0.875rem;
    opacity: 0.4;
    transition: transform 0.2s ease, opacity 0.15s ease;
  }

  .sidebar-nav-group-title:hover .nav-chevron {
    opacity: 0.7;
  }

  .nav-group-content {
    overflow: hidden;
    margin-top: 0.25rem;
  }

  .nav-group-content ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .sidebar-nav-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    margin-left: 0.25rem;
    font-size: 0.8125rem;
    color: var(--color-text-tertiary);
    border-radius: 0.375rem;
    border-left: 2px solid transparent;
    transition: all 0.15s ease;
  }

  .sidebar-nav-item:hover {
    color: var(--color-menu-item-hover-text);
    background-color: var(--color-menu-item-hover-bg);
  }

  .sidebar-nav-item.active {
    color: var(--color-menu-item-active-text, var(--color-primary));
    background-color: var(--color-menu-item-active-bg, var(--color-primary-5));
    border-left-color: var(--color-menu-item-active-text, var(--color-primary));
    font-weight: 500;
  }

  :global(.dark) .sidebar-nav-item.active {
    color: var(--color-menu-item-active-text, var(--color-accent-light));
    background-color: var(--color-menu-item-active-bg, var(--color-accent-10));
    border-left-color: var(--color-menu-item-active-text, var(--color-accent-light));
  }

  .nav-item-icon {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
    opacity: 0.5;
  }

  .sidebar-nav-item:hover .nav-item-icon {
    opacity: 1;
  }

  .sidebar-nav-item.active .nav-item-icon {
    opacity: 1;
  }

  .nav-item-label {
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .sidebar-nav-subgroup {
    margin-top: 0.375rem;
    margin-left: 0.5rem;
    padding-left: 0.75rem;
    border-left: 1px solid var(--color-border-light);
  }

  .sidebar-nav-subgroup-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 0.375rem 0.625rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--color-text-tertiary);
    background: transparent;
    border: none;
    cursor: pointer;
    border-radius: 0.25rem;
    transition: all 0.15s ease;
  }

  .sidebar-nav-subgroup-title:hover {
    color: var(--color-menu-item-hover-text);
    background-color: var(--color-menu-item-hover-bg);
  }

  .nav-chevron-sub {
    width: 0.75rem;
    height: 0.75rem;
    opacity: 0.4;
    transition: transform 0.2s ease;
  }

  .sidebar-nav-subgroup-title:hover .nav-chevron-sub {
    opacity: 0.7;
  }

  .nav-subgroup-content {
    list-style: none;
    margin: 0;
    padding: 0;
    margin-top: 0.25rem;
  }

  .sidebar-nav-item-nested {
    padding-left: 1rem;
    font-size: 0.8125rem;
    margin-left: 0;
    border-left: none;
  }

  .sidebar-nav-item-nested.active {
    background-color: var(--color-menu-item-active-bg, var(--color-primary-5));
  }

  :global(.dark) .sidebar-nav-item-nested.active {
    background-color: var(--color-menu-item-active-bg, var(--color-accent-10));
  }

  /* Footer  fixed at bottom */
  .sidebar-footer {
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    border-top: 1px solid var(--color-border);
    margin-top: auto;
  }

  /* Language Selector  matches home header style */
  .sidebar-lang-selector {
    position: relative;
  }

  .sidebar-lang-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.5rem;
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
    background: transparent;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .sidebar-lang-btn:hover {
    color: var(--color-text-primary);
    background-color: var(--color-background-secondary);
  }

  .sidebar-lang-icon {
    width: 0.875rem;
    height: 0.875rem;
    opacity: 0.7;
  }

  .sidebar-lang-code {
    font-weight: 600;
    font-size: 0.75rem;
  }

  .sidebar-lang-chevron {
    width: 0.625rem;
    height: 0.625rem;
    opacity: 0.5;
    transition: transform 0.2s ease;
  }

  .sidebar-lang-selector.open .sidebar-lang-chevron {
    transform: rotate(180deg);
  }

  .sidebar-lang-dropdown {
    position: absolute;
    bottom: 100%;
    left: 0;
    margin-bottom: 0.5rem;
    min-width: 140px;
    padding: 0.25rem;
    background: var(--color-bg-primary, #ffffff);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    opacity: 0;
    visibility: hidden;
    transform: translateY(0.5rem);
    transition: all 0.15s ease;
    z-index: 100;
  }

  :global(.dark) .sidebar-lang-dropdown {
    background: var(--color-bg-primary, #0b1220);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
  }

  .sidebar-lang-selector.open .sidebar-lang-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .sidebar-lang-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4375rem 0.625rem;
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    border-radius: 0.375rem;
    transition: all 0.15s ease;
    text-decoration: none;
  }

  .sidebar-lang-option:hover {
    color: var(--color-text-primary);
    background-color: var(--color-background-secondary);
  }

  .sidebar-lang-option.active {
    color: var(--color-primary);
    background-color: var(--color-primary-5, rgba(var(--color-primary-rgb, 0,0,0), 0.05));
    font-weight: 500;
  }

  .sidebar-lang-option-code {
    font-weight: 600;
    width: 1.5rem;
  }

  .sidebar-lang-option-name {
    flex: 1;
    color: var(--color-text-muted);
  }

  .sidebar-lang-option.active .sidebar-lang-option-name {
    color: var(--color-primary);
    opacity: 0.7;
  }

  .sidebar-lang-check {
    width: 0.875rem;
    height: 0.875rem;
    color: var(--color-primary);
  }

  /* Theme Controls */
  .theme-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .theme-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    color: var(--color-text-tertiary);
    background: transparent;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .theme-btn:hover {
    color: var(--color-menu-item-hover-text);
    background-color: var(--color-menu-item-hover-bg);
  }

  .theme-icon-light,
  .theme-icon-dark {
    width: 1.125rem;
    height: 1.125rem;
  }

  .theme-icon-dark {
    display: none;
  }

  :global(.dark) .theme-icon-light {
    display: none;
  }

  :global(.dark) .theme-icon-dark {
    display: block;
  }

  /* Mobile - needs background when open as overlay */
  @media (max-width: 1024px) {
    .sidebar {
      transform: translateX(-100%);
    }

    .sidebar.open {
      transform: translateX(0);
      background-color: var(--color-surface);
    }

    :global(.dark) .sidebar.open {
      background-color: var(--color-bg-primary);
    }
  }
</style>
