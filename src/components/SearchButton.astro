---
/**
 * SearchButton Component - AI-powered search with rich result cards
 * Keyboard shortcut: Cmd/Ctrl + K
 * Uses AutoRAG chat-rag endpoint for intelligent doc search
 */
import Icon from './Icon';
const CMS_URL = import.meta.env.CMS_URL || 'http://localhost:3000';
const CMS_API_KEY = import.meta.env.CMS_API_KEY || '';
---

<button
  id="search-btn"
  class="flex items-center gap-2 px-3 py-2 rounded-lg border border-[var(--color-border)] bg-[var(--color-background-secondary)] text-[var(--color-text-muted)] hover:border-[var(--color-text-muted)] transition-colors text-[0.8125rem] leading-[1.125rem]"
  aria-label="Search documentation"
>
  <Icon name="search" className="w-4 h-4" aria-hidden={true} client:only="react" />
  <span class="hidden sm:inline">Search</span>
  <kbd class="hidden sm:inline-flex items-center gap-1 ml-2 px-1.5 py-0.5 rounded bg-[var(--color-background-tertiary)] text-xs">
    <span class="text-[10px]">⌘</span>K
  </kbd>
</button>

<!-- Search Modal - Portal to body for proper stacking -->
<div
  id="search-modal"
  class="search-modal-overlay hidden"
  role="dialog"
  aria-modal="true"
  data-cms-url={CMS_URL}
  data-cms-api-key={CMS_API_KEY}
>
  <!-- Backdrop - covers entire screen including sidebar -->
  <div class="search-modal-backdrop" id="search-backdrop"></div>

  <!-- Modal Content -->
  <div class="search-modal-content">
    <div class="search-modal-card">
      <!-- Search Input -->
      <div class="search-input-row">
        <svg class="search-input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <input
          type="text"
          id="search-input"
          class="search-input"
          placeholder="Search documentation..."
          autocomplete="off"
        />
        <kbd class="search-esc-badge">ESC</kbd>
      </div>

      <!-- Search Results -->
      <div id="search-results" class="search-results">
        <div class="search-empty-state">
          <div class="search-empty-icon">
            <svg viewBox="0 0 22 22" fill="none">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M7.517 8.773L13 19.772l-5.5-1.343L2 19.772l5.515-10.999h.002z" fill="currentColor"/>
              <path d="M16.596 7s.237 2.217 1.162 3.142c.925.925 3.142 1.162 3.142 1.162s-2.217.238-3.142 1.163c-.925.925-1.162 3.141-1.162 3.141s-.238-2.216-1.163-3.141c-.925-.926-3.142-1.163-3.142-1.163s2.217-.237 3.142-1.162C16.358 9.217 16.596 7 16.596 7z" fill="currentColor"/>
              <path d="M13.726 4s.132 1.232.646 1.745c.514.514 1.746.646 1.746.646s-1.232.132-1.746.646c-.514.514-.646 1.745-.646 1.745s-.132-1.231-.646-1.745c-.514-.514-1.745-.646-1.745-.646s1.231-.132 1.745-.646c.514-.514.646-1.745.646-1.745z" fill="currentColor"/>
              <path d="M18.509 3s.08.739.388 1.047c.308.308 1.047.387 1.047.387s-.739.08-1.047.388c-.308.308-.388 1.047-.388 1.047s-.079-.739-.387-1.047c-.309-.309-1.048-.388-1.048-.388s.74-.079 1.048-.387c.308-.308.387-1.047.387-1.047z" fill="currentColor"/>
            </svg>
          </div>
          <p class="search-empty-title">AI-powered search</p>
          <p class="search-empty-desc">Ask a question or search the documentation</p>
        </div>
      </div>

      <!-- Footer -->
      <div class="search-footer">
        <div class="search-footer-keys">
          <span class="search-footer-key">
            <kbd>↑↓</kbd>
            navigate
          </span>
          <span class="search-footer-key">
            <kbd>↵</kbd>
            select
          </span>
        </div>
        <div class="search-footer-brand">
          <svg class="search-footer-ai-icon" viewBox="0 0 22 22" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M7.517 8.773L13 19.772l-5.5-1.343L2 19.772l5.515-10.999h.002z" fill="currentColor"/>
            <path d="M16.596 7s.237 2.217 1.162 3.142c.925.925 3.142 1.162 3.142 1.162s-2.217.238-3.142 1.163c-.925.925-1.162 3.141-1.162 3.141s-.238-2.216-1.163-3.141c-.925-.926-3.142-1.163-3.142-1.163s2.217-.237 3.142-1.162C16.358 9.217 16.596 7 16.596 7z" fill="currentColor"/>
            <path d="M13.726 4s.132 1.232.646 1.745c.514.514 1.746.646 1.746.646s-1.232.132-1.746.646c-.514.514-.646 1.745-.646 1.745s-.132-1.231-.646-1.745c-.514-.514-1.745-.646-1.745-.646s1.231-.132 1.745-.646c.514-.514.646-1.745.646-1.745z" fill="currentColor"/>
            <path d="M18.509 3s.08.739.388 1.047c.308.308 1.047.387 1.047.387s-.739.08-1.047.388c-.308.308-.388 1.047-.388 1.047s-.079-.739-.387-1.047c-.309-.309-1.048-.388-1.048-.388s.74-.079 1.048-.387c.308-.308.387-1.047.387-1.047z" fill="currentColor"/>
          </svg>
          Powered by AI
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function initSearch() {
    const searchBtn = document.getElementById('search-btn');
    let searchModal = document.getElementById('search-modal');
    const searchBackdrop = document.getElementById('search-backdrop');
    const searchInput = document.getElementById('search-input') as HTMLInputElement | null;
    const searchResults = document.getElementById('search-results');

    if (!searchBtn || !searchModal || !searchBackdrop || !searchInput || !searchResults) return;

    // Teleport modal to body to escape stacking contexts
    if (searchModal.parentElement !== document.body) {
      document.body.appendChild(searchModal);
    }

    const modal = searchModal;
    const input = searchInput;
    const results = searchResults;
    const CMS_URL = modal.dataset.cmsUrl || '';
    const CMS_API_KEY = modal.dataset.cmsApiKey || '';

    let debounceTimer: ReturnType<typeof setTimeout> | null = null;
    let currentRequest: AbortController | null = null;
    let selectedIndex = -1;
    let isLoading = false;

    // Thinking phrases
    const thinkingPhrases = [
      'Searching docs...',
      'Reading content...',
      'Finding answers...',
      'Connecting ideas...',
      'Crafting response...',
    ];

    function getPageContext() {
      const path = window.location.pathname;
      const parts = path.split('/').filter(Boolean);
      // Only send locale — URL path segments don't map to DB collection names
      return { locale: parts[0] || 'en' };
    }

    // --- Open / Close ---
    function openSearch() {
      modal.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
      input.focus();
      input.select();
    }

    function closeSearch() {
      modal.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      input.value = '';
      resetResults();
      if (currentRequest) {
        currentRequest.abort();
        currentRequest = null;
      }
    }

    function resetResults() {
      selectedIndex = -1;
      results.innerHTML = `
        <div class="search-empty-state">
          <div class="search-empty-icon">
            <svg viewBox="0 0 22 22" fill="none">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M7.517 8.773L13 19.772l-5.5-1.343L2 19.772l5.515-10.999h.002z" fill="currentColor"/>
              <path d="M16.596 7s.237 2.217 1.162 3.142c.925.925 3.142 1.162 3.142 1.162s-2.217.238-3.142 1.163c-.925.925-1.162 3.141-1.162 3.141s-.238-2.216-1.163-3.141c-.925-.926-3.142-1.163-3.142-1.163s2.217-.237 3.142-1.162C16.358 9.217 16.596 7 16.596 7z" fill="currentColor"/>
              <path d="M13.726 4s.132 1.232.646 1.745c.514.514 1.746.646 1.746.646s-1.232.132-1.746.646c-.514.514-.646 1.745-.646 1.745s-.132-1.231-.646-1.745c-.514-.514-1.745-.646-1.745-.646s1.231-.132 1.745-.646c.514-.514.646-1.745.646-1.745z" fill="currentColor"/>
              <path d="M18.509 3s.08.739.388 1.047c.308.308 1.047.387 1.047.387s-.739.08-1.047.388c-.308.308-.388 1.047-.388 1.047s-.079-.739-.387-1.047c-.309-.309-1.048-.388-1.048-.388s.74-.079 1.048-.387c.308-.308.387-1.047.387-1.047z" fill="currentColor"/>
            </svg>
          </div>
          <p class="search-empty-title">AI-powered search</p>
          <p class="search-empty-desc">Ask a question or search the documentation</p>
        </div>
      `;
    }

    // --- Loading indicator with cycling phrases ---
    function showLoading() {
      isLoading = true;
      let phraseIndex = 0;
      results.innerHTML = `
        <div class="search-loading">
          <div class="search-loading-dots">
            <span></span><span></span><span></span>
          </div>
          <span class="search-loading-text">${thinkingPhrases[0]}</span>
        </div>
      `;
      const textEl = results.querySelector('.search-loading-text');
      const interval = setInterval(() => {
        if (!isLoading) { clearInterval(interval); return; }
        phraseIndex = (phraseIndex + 1) % thinkingPhrases.length;
        if (textEl) textEl.textContent = thinkingPhrases[phraseIndex];
      }, 2400);
      (results as any)._loadingInterval = interval;
    }

    function hideLoading() {
      isLoading = false;
      if ((results as any)._loadingInterval) {
        clearInterval((results as any)._loadingInterval);
        delete (results as any)._loadingInterval;
      }
    }

    // --- Render results ---
    interface Source { title: string; collection: string; locale: string; slug: string; path?: string; }

    function renderResults(answer: string, sources: Source[], suggestions: string[]) {
      hideLoading();
      results.innerHTML = '';

      // Answer card
      if (answer) {
        const answerCard = document.createElement('div');
        answerCard.className = 'search-answer-card';
        answerCard.innerHTML = `
          <div class="search-answer-header">
            <svg class="search-answer-icon" viewBox="0 0 22 22" fill="none">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M7.517 8.773L13 19.772l-5.5-1.343L2 19.772l5.515-10.999h.002z" fill="currentColor"/>
              <path d="M16.596 7s.237 2.217 1.162 3.142c.925.925 3.142 1.162 3.142 1.162s-2.217.238-3.142 1.163c-.925.925-1.162 3.141-1.162 3.141s-.238-2.216-1.163-3.141c-.925-.926-3.142-1.163-3.142-1.163s2.217-.237 3.142-1.162C16.358 9.217 16.596 7 16.596 7z" fill="currentColor"/>
              <path d="M13.726 4s.132 1.232.646 1.745c.514.514 1.746.646 1.746.646s-1.232.132-1.746.646c-.514.514-.646 1.745-.646 1.745s-.132-1.231-.646-1.745c-.514-.514-1.745-.646-1.745-.646s1.231-.132 1.745-.646c.514-.514.646-1.745.646-1.745z" fill="currentColor"/>
              <path d="M18.509 3s.08.739.388 1.047c.308.308 1.047.387 1.047.387s-.739.08-1.047.388c-.308.308-.388 1.047-.388 1.047s-.079-.739-.387-1.047c-.309-.309-1.048-.388-1.048-.388s.74-.079 1.048-.387c.308-.308.387-1.047.387-1.047z" fill="currentColor"/>
            </svg>
            <span>AI Answer</span>
          </div>
          <div class="search-answer-body">${simpleMarkdown(answer)}</div>
        `;
        results.appendChild(answerCard);
      }

      // Source cards
      if (sources && sources.length > 0) {
        const sourcesSection = document.createElement('div');
        sourcesSection.className = 'search-sources-section';

        const sourcesLabel = document.createElement('div');
        sourcesLabel.className = 'search-sources-label';
        sourcesLabel.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 19.5A2.5 2.5 0 016.5 17H20"/>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/>
          </svg>
          <span>Related docs</span>
        `;
        sourcesSection.appendChild(sourcesLabel);

        const grid = document.createElement('div');
        grid.className = 'search-sources-grid';

        for (const source of sources.slice(0, 5)) {
          const card = document.createElement('a');
          const href = source.slug
            ? `/${source.locale || 'en'}/${source.collection}/${source.slug}`
            : '#';
          card.href = href;
          card.className = 'search-source-card';
          card.setAttribute('data-search-result', '');

          // Icon by collection type
          const iconSvg = getCollectionIcon(source.collection);

          card.innerHTML = `
            <div class="search-source-card-icon">${iconSvg}</div>
            <div class="search-source-card-body">
              <div class="search-source-card-title">${escapeHtml(source.title)}</div>
              <div class="search-source-card-meta">
                <span class="search-source-badge">${escapeHtml(source.collection || 'docs')}</span>
                ${source.slug ? `<span class="search-source-path">/${source.slug}</span>` : ''}
              </div>
            </div>
            <svg class="search-source-card-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          `;

          card.addEventListener('click', () => closeSearch());
          grid.appendChild(card);
        }

        sourcesSection.appendChild(grid);
        results.appendChild(sourcesSection);
      }

      // Suggestion pills
      if (suggestions && suggestions.length > 0) {
        const suggestionsEl = document.createElement('div');
        suggestionsEl.className = 'search-suggestions';

        const label = document.createElement('div');
        label.className = 'search-suggestions-label';
        label.textContent = 'Related questions';
        suggestionsEl.appendChild(label);

        const pills = document.createElement('div');
        pills.className = 'search-suggestions-pills';

        for (const text of suggestions.slice(0, 3)) {
          const btn = document.createElement('button');
          btn.className = 'search-suggestion-pill';
          btn.textContent = text;
          btn.addEventListener('click', () => {
            input.value = text;
            performSearch(text);
          });
          pills.appendChild(btn);
        }

        suggestionsEl.appendChild(pills);
        results.appendChild(suggestionsEl);
      }

      // No results state
      if (!answer && (!sources || sources.length === 0)) {
        results.innerHTML = `
          <div class="search-no-results">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
              <line x1="8" y1="11" x2="14" y2="11"/>
            </svg>
            <p>No results found</p>
            <p class="search-no-results-hint">Try rephrasing your question</p>
          </div>
        `;
      }

      // Reset selection
      selectedIndex = -1;
      updateSelection();
    }

    function renderError(message: string) {
      hideLoading();
      results.innerHTML = `
        <div class="search-error">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <p>${escapeHtml(message)}</p>
        </div>
      `;
    }

    // --- Search execution (two-phase: sources first, then AI answer) ---
    async function performSearch(query: string) {
      if (!query.trim()) {
        resetResults();
        return;
      }

      // Cancel previous requests
      if (currentRequest) {
        currentRequest.abort();
      }
      currentRequest = new AbortController();
      const signal = currentRequest.signal;

      showLoading();

      const headers: Record<string, string> = { 'Content-Type': 'application/json' };
      if (CMS_API_KEY) headers['x-api-key'] = CMS_API_KEY;

      const { locale } = getPageContext();

      // --- Phase 1: Fast document search (instant results) ---
      try {
        const searchRes = await fetch(`${CMS_URL}/api/ai/search-docs`, {
          method: 'POST',
          headers,
          signal,
          body: JSON.stringify({ query, locale })
        });

        if (searchRes.ok) {
          const searchData = await searchRes.json();
          if (searchData.sources && searchData.sources.length > 0) {
            // Render sources immediately + AI loading indicator on top
            renderSourcesWithAILoading(searchData.sources);
          }
        }
      } catch (err: any) {
        if (err.name === 'AbortError') return;
        // Phase 1 failed — continue to phase 2 anyway
      }

      // --- Phase 2: AI-generated answer (slower) ---
      try {
        const chatRes = await fetch(`${CMS_URL}/api/ai/chat-rag`, {
          method: 'POST',
          headers,
          signal,
          body: JSON.stringify({ message: query, locale })
        });

        if (signal.aborted) return;

        if (!chatRes.ok) {
          const err = await chatRes.json().catch(() => ({}));
          // If we already have sources showing, just remove the AI loading
          const aiLoading = results.querySelector('.search-ai-loading');
          if (aiLoading) {
            aiLoading.remove();
          } else {
            renderError(err.message || 'Search failed. Please try again.');
          }
          return;
        }

        const data = await chatRes.json();
        // Merge AI answer into existing results
        renderResults(data.answer || '', data.sources || [], data.suggestions || []);
      } catch (err: any) {
        if (err.name === 'AbortError') return;
        // If we have sources showing, just remove the AI loading indicator
        const aiLoading = results.querySelector('.search-ai-loading');
        if (aiLoading) {
          aiLoading.remove();
          hideLoading();
        } else {
          renderError('Failed to connect to search service.');
        }
      }
    }

    // Render sources immediately with AI loading indicator on top
    function renderSourcesWithAILoading(sources: Array<{ title: string; collection: string; locale: string; slug: string; path?: string; snippet?: string }>) {
      hideLoading();
      results.innerHTML = '';

      // AI loading card (will be replaced by AI answer)
      const aiLoadingEl = document.createElement('div');
      aiLoadingEl.className = 'search-ai-loading';
      let phraseIdx = 0;
      const aiPhrases = ['Generating AI answer...', 'Analyzing docs...', 'Crafting response...'];
      aiLoadingEl.innerHTML = `
        <div class="search-answer-card search-answer-card--loading">
          <div class="search-answer-header">
            <svg class="search-answer-icon" viewBox="0 0 22 22" fill="none">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M7.517 8.773L13 19.772l-5.5-1.343L2 19.772l5.515-10.999h.002z" fill="currentColor"/>
              <path d="M16.596 7s.237 2.217 1.162 3.142c.925.925 3.142 1.162 3.142 1.162s-2.217.238-3.142 1.163c-.925.925-1.162 3.141-1.162 3.141s-.238-2.216-1.163-3.141c-.925-.926-3.142-1.163-3.142-1.163s2.217-.237 3.142-1.162C16.358 9.217 16.596 7 16.596 7z" fill="currentColor"/>
              <path d="M13.726 4s.132 1.232.646 1.745c.514.514 1.746.646 1.746.646s-1.232.132-1.746.646c-.514.514-.646 1.745-.646 1.745s-.132-1.231-.646-1.745c-.514-.514-1.745-.646-1.745-.646s1.231-.132 1.745-.646c.514-.514.646-1.745.646-1.745z" fill="currentColor"/>
              <path d="M18.509 3s.08.739.388 1.047c.308.308 1.047.387 1.047.387s-.739.08-1.047.388c-.308.308-.388 1.047-.388 1.047s-.079-.739-.387-1.047c-.309-.309-1.048-.388-1.048-.388s.74-.079 1.048-.387c.308-.308.387-1.047.387-1.047z" fill="currentColor"/>
            </svg>
            <span>AI Answer</span>
          </div>
          <div class="search-answer-body">
            <div class="search-loading" style="padding: 0.5rem 0; justify-content: flex-start;">
              <div class="search-loading-dots"><span></span><span></span><span></span></div>
              <span class="search-ai-loading-text">${aiPhrases[0]}</span>
            </div>
          </div>
        </div>
      `;
      results.appendChild(aiLoadingEl);

      // Cycle AI loading phrases
      const aiInterval = setInterval(() => {
        const textEl = aiLoadingEl.querySelector('.search-ai-loading-text');
        if (!textEl || !aiLoadingEl.parentElement) { clearInterval(aiInterval); return; }
        phraseIdx = (phraseIdx + 1) % aiPhrases.length;
        textEl.textContent = aiPhrases[phraseIdx];
      }, 2400);
      (aiLoadingEl as any)._interval = aiInterval;

      // Render source cards below
      renderSourceCards(sources);
    }

    // Render just the source cards (reusable for phase 1)
    function renderSourceCards(sources: Array<{ title: string; collection: string; locale: string; slug: string; path?: string; snippet?: string }>) {
      const sourcesSection = document.createElement('div');
      sourcesSection.className = 'search-sources-section';
      sourcesSection.id = 'search-phase1-sources';

      const sourcesLabel = document.createElement('div');
      sourcesLabel.className = 'search-sources-label';
      sourcesLabel.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 19.5A2.5 2.5 0 016.5 17H20"/>
          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/>
        </svg>
        <span>Related docs</span>
      `;
      sourcesSection.appendChild(sourcesLabel);

      const grid = document.createElement('div');
      grid.className = 'search-sources-grid';

      for (const source of sources.slice(0, 6)) {
        const card = document.createElement('a');
        const href = source.slug
          ? `/${source.locale || 'en'}/${source.collection}/${source.slug}`
          : '#';
        card.href = href;
        card.className = 'search-source-card';
        card.setAttribute('data-search-result', '');

        const iconSvg = getCollectionIcon(source.collection);

        card.innerHTML = `
          <div class="search-source-card-icon">${iconSvg}</div>
          <div class="search-source-card-body">
            <div class="search-source-card-title">${escapeHtml(source.title)}</div>
            <div class="search-source-card-meta">
              <span class="search-source-badge">${escapeHtml(source.collection || 'docs')}</span>
              ${source.slug ? `<span class="search-source-path">/${source.slug}</span>` : ''}
            </div>
            ${source.snippet ? `<div class="search-source-card-snippet">${escapeHtml(source.snippet)}</div>` : ''}
          </div>
          <svg class="search-source-card-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        `;

        card.addEventListener('click', () => closeSearch());
        grid.appendChild(card);
      }

      sourcesSection.appendChild(grid);
      results.appendChild(sourcesSection);

      // Update keyboard selection
      selectedIndex = -1;
      updateSelection();
    }

    // --- Keyboard navigation ---
    function getResultCards(): HTMLElement[] {
      return Array.from(results.querySelectorAll('[data-search-result]'));
    }

    function updateSelection() {
      const cards = getResultCards();
      cards.forEach((card, i) => {
        card.classList.toggle('selected', i === selectedIndex);
      });
      // Scroll selected into view
      if (selectedIndex >= 0 && cards[selectedIndex]) {
        cards[selectedIndex].scrollIntoView({ block: 'nearest' });
      }
    }

    // --- Event listeners ---

    // Debounced search on input
    input.addEventListener('input', () => {
      if (debounceTimer) clearTimeout(debounceTimer);
      const query = input.value.trim();
      if (!query) {
        if (currentRequest) { currentRequest.abort(); currentRequest = null; }
        hideLoading();
        resetResults();
        return;
      }
      debounceTimer = setTimeout(() => performSearch(query), 500);
    });

    // Enter to search immediately or navigate
    input.addEventListener('keydown', (e) => {
      const cards = getResultCards();

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, cards.length - 1);
        updateSelection();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelection();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selectedIndex >= 0 && cards[selectedIndex]) {
          const link = cards[selectedIndex] as HTMLAnchorElement;
          if (link.href) { window.location.href = link.href; closeSearch(); }
        } else if (input.value.trim()) {
          if (debounceTimer) clearTimeout(debounceTimer);
          performSearch(input.value.trim());
        }
      }
    });

    // Open on button click
    searchBtn.addEventListener('click', openSearch);

    // Close on backdrop click
    searchBackdrop.addEventListener('click', closeSearch);

    // Close on ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeSearch();
      }
    });

    // Open on Cmd/Ctrl + K
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (modal.classList.contains('hidden')) {
          openSearch();
        } else {
          closeSearch();
        }
      }
    });

    // Also trigger from sidebar search
    const sidebarSearch = document.querySelector('[data-search-trigger]');
    if (sidebarSearch) {
      sidebarSearch.addEventListener('click', openSearch);
    }
  }

  // --- Utilities ---
  function escapeHtml(str: string): string {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function simpleMarkdown(text: string): string {
    // Basic markdown rendering
    const codeBlocks: string[] = [];
    let processed = text.replace(/```[\s\S]*?```/g, (match) => {
      codeBlocks.push(match);
      return `%%CODEBLOCK_${codeBlocks.length - 1}%%`;
    });

    // Inline code
    processed = processed.replace(/`([^`]+)`/g, '<code>$1</code>');
    // Bold
    processed = processed.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    // Italic
    processed = processed.replace(/\*(.+?)\*/g, '<em>$1</em>');
    // Links
    processed = processed.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="search-md-link">$1</a>');
    // Lists
    processed = processed.replace(/^[-*] (.+)$/gm, '<li>$1</li>');
    processed = processed.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
    // Numbered lists
    processed = processed.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
    // Headers
    processed = processed.replace(/^### (.+)$/gm, '<h4>$1</h4>');
    processed = processed.replace(/^## (.+)$/gm, '<h3>$1</h3>');
    processed = processed.replace(/^# (.+)$/gm, '<h2>$1</h2>');
    // Paragraphs
    processed = processed.replace(/\n\n/g, '</p><p>');
    processed = '<p>' + processed + '</p>';
    processed = processed.replace(/<p><\/p>/g, '');
    // Line breaks
    processed = processed.replace(/\n/g, '<br>');

    // Restore code blocks
    processed = processed.replace(/%%CODEBLOCK_(\d+)%%/g, (_, idx) => {
      const block = codeBlocks[parseInt(idx)];
      const content = block.replace(/^```\w*\n?/, '').replace(/\n?```$/, '');
      return `<pre><code>${escapeHtml(content)}</code></pre>`;
    });

    return processed;
  }

  function getCollectionIcon(collection: string): string {
    const icons: Record<string, string> = {
      guides: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>',
      api: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5"/></svg>',
      reference: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>',
    };
    return icons[collection] || '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>';
  }

  initSearch();
  document.addEventListener('astro:after-swap', initSearch);
</script>

<style is:global>
  /* ---- Modal overlay ---- */
  .search-modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    isolation: isolate;
  }

  .search-modal-overlay.hidden {
    display: none !important;
  }

  .search-modal-backdrop {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  .search-modal-content {
    position: fixed;
    left: 1rem;
    right: 1rem;
    top: 12vh;
    margin: 0 auto;
    max-width: 40rem;
    animation: search-modal-in 0.2s ease-out;
  }

  @keyframes search-modal-in {
    from { opacity: 0; transform: translateY(-8px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  .search-modal-card {
    background: var(--color-surface, #ffffff);
    border: 1px solid var(--color-border);
    border-radius: 1rem;
    box-shadow:
      0 0 0 1px rgba(0, 0, 0, 0.03),
      0 2px 4px rgba(0, 0, 0, 0.04),
      0 12px 24px rgba(0, 0, 0, 0.08),
      0 24px 48px rgba(0, 0, 0, 0.06);
    overflow: hidden;
  }

  .dark .search-modal-card {
    box-shadow:
      0 0 0 1px rgba(255, 255, 255, 0.06),
      0 2px 4px rgba(0, 0, 0, 0.2),
      0 12px 24px rgba(0, 0, 0, 0.3),
      0 24px 48px rgba(0, 0, 0, 0.2);
  }

  /* ---- Input row ---- */
  .search-input-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 1.25rem;
    border-bottom: 1px solid var(--color-border);
  }

  .search-input-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--color-text-muted);
    flex-shrink: 0;
  }

  .search-input {
    flex: 1;
    padding: 0.5rem;
    background: transparent;
    border: none;
    font-size: 0.9375rem;
    color: var(--color-text-primary);
    outline: none;
  }

  .search-input::placeholder {
    color: var(--color-text-muted);
  }

  .search-esc-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    background: var(--color-background-tertiary);
    font-size: 0.6875rem;
    color: var(--color-text-muted);
    font-family: inherit;
    border: none;
  }

  /* ---- Results container ---- */
  .search-results {
    max-height: 56vh;
    overflow-y: auto;
    padding: 0.5rem;
    scroll-behavior: smooth;
  }

  .search-results::-webkit-scrollbar {
    width: 6px;
  }

  .search-results::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 3px;
  }

  /* ---- Empty state ---- */
  .search-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2.5rem 1rem;
    gap: 0.5rem;
  }

  .search-empty-icon {
    width: 2.5rem;
    height: 2.5rem;
    color: var(--color-primary, #6366f1);
    opacity: 0.5;
    margin-bottom: 0.25rem;
  }

  .search-empty-icon svg {
    width: 100%;
    height: 100%;
  }

  .search-empty-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 0;
  }

  .search-empty-desc {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    margin: 0;
  }

  /* ---- Loading state ---- */
  .search-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 2.5rem 1rem;
  }

  .search-loading-dots {
    display: flex;
    gap: 0.25rem;
  }

  .search-loading-dots span {
    width: 0.375rem;
    height: 0.375rem;
    border-radius: 50%;
    background: var(--color-primary, #6366f1);
    animation: search-dot-bounce 1.4s infinite ease-in-out both;
  }

  .search-loading-dots span:nth-child(1) { animation-delay: -0.32s; }
  .search-loading-dots span:nth-child(2) { animation-delay: -0.16s; }
  .search-loading-dots span:nth-child(3) { animation-delay: 0; }

  @keyframes search-dot-bounce {
    0%, 80%, 100% { transform: scale(0); opacity: 0.4; }
    40% { transform: scale(1); opacity: 1; }
  }

  .search-loading-text {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    animation: search-text-fade 0.3s ease;
  }

  @keyframes search-text-fade {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* ---- Answer card ---- */
  .search-answer-card {
    margin: 0.25rem;
    padding: 1rem 1.25rem;
    border-radius: 0.75rem;
    background: linear-gradient(135deg,
      rgba(var(--color-primary-rgb, 99, 102, 241), 0.04) 0%,
      rgba(var(--color-primary-rgb, 99, 102, 241), 0.01) 100%
    );
    border: 1px solid rgba(var(--color-primary-rgb, 99, 102, 241), 0.1);
  }

  .dark .search-answer-card {
    background: linear-gradient(135deg,
      rgba(var(--color-primary-rgb, 99, 102, 241), 0.08) 0%,
      rgba(var(--color-primary-rgb, 99, 102, 241), 0.02) 100%
    );
    border-color: rgba(var(--color-primary-rgb, 99, 102, 241), 0.15);
  }

  .search-answer-header {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    margin-bottom: 0.625rem;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-primary, #6366f1);
  }

  .search-answer-icon {
    width: 0.875rem;
    height: 0.875rem;
  }

  .search-answer-body {
    font-size: 0.8125rem;
    line-height: 1.6;
    color: var(--color-text-primary);
  }

  .search-answer-body p {
    margin: 0 0 0.5rem;
  }

  .search-answer-body p:last-child {
    margin-bottom: 0;
  }

  .search-answer-body code {
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    background: var(--color-background-tertiary);
    font-size: 0.75rem;
    font-family: ui-monospace, 'SF Mono', SFMono-Regular, 'Cascadia Code', 'Liberation Mono', Menlo, monospace;
  }

  .search-answer-body pre {
    margin: 0.5rem 0;
    padding: 0.75rem;
    border-radius: 0.5rem;
    background: var(--color-background-tertiary);
    overflow-x: auto;
  }

  .search-answer-body pre code {
    padding: 0;
    background: none;
    font-size: 0.75rem;
  }

  .search-answer-body strong {
    font-weight: 600;
    color: var(--color-text-primary);
  }

  .search-answer-body ul, .search-answer-body ol {
    margin: 0.375rem 0;
    padding-left: 1.25rem;
  }

  .search-answer-body li {
    margin-bottom: 0.25rem;
  }

  .search-md-link {
    color: var(--color-primary, #6366f1);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  /* ---- Sources section ---- */
  .search-sources-section {
    padding: 0.5rem 0.25rem;
  }

  .search-sources-label {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
  }

  .search-sources-label svg {
    width: 0.8125rem;
    height: 0.8125rem;
  }

  .search-sources-grid {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  /* ---- Source card ---- */
  .search-source-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.75rem;
    border-radius: 0.625rem;
    text-decoration: none;
    color: var(--color-text-primary);
    transition: all 0.15s ease;
    cursor: pointer;
  }

  .search-source-card:hover,
  .search-source-card.selected {
    background: var(--color-background-secondary, #f8f9fa);
  }

  .dark .search-source-card:hover,
  .dark .search-source-card.selected {
    background: rgba(255, 255, 255, 0.05);
  }

  .search-source-card-icon {
    flex-shrink: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    background: var(--color-background-tertiary);
    color: var(--color-text-muted);
  }

  .search-source-card-icon svg {
    width: 1.125rem;
    height: 1.125rem;
  }

  .search-source-card-body {
    flex: 1;
    min-width: 0;
  }

  .search-source-card-title {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .search-source-card-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.125rem;
  }

  .search-source-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.0625rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--color-primary, #6366f1);
    background: rgba(var(--color-primary-rgb, 99, 102, 241), 0.08);
  }

  .search-source-path {
    font-size: 0.6875rem;
    color: var(--color-text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .search-source-card-snippet {
    font-size: 0.6875rem;
    color: var(--color-text-muted);
    margin-top: 0.25rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .search-source-card-arrow {
    flex-shrink: 0;
    width: 1rem;
    height: 1rem;
    color: var(--color-text-muted);
    opacity: 0;
    transition: all 0.15s ease;
  }

  .search-source-card:hover .search-source-card-arrow,
  .search-source-card.selected .search-source-card-arrow {
    opacity: 1;
    transform: translateX(2px);
  }

  /* AI loading card (phase 1 → waiting for AI answer) */
  .search-ai-loading {
    animation: search-fade-in 0.3s ease;
  }

  .search-answer-card--loading {
    opacity: 0.85;
  }

  .search-answer-card--loading .search-answer-header {
    animation: search-ai-pulse 2s ease-in-out infinite;
  }

  @keyframes search-ai-pulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
  }

  @keyframes search-fade-in {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ---- Suggestions ---- */
  .search-suggestions {
    padding: 0.5rem 0.25rem 0.75rem;
  }

  .search-suggestions-label {
    padding: 0.375rem 0.75rem;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
  }

  .search-suggestions-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    padding: 0.25rem 0.5rem;
  }

  .search-suggestion-pill {
    padding: 0.375rem 0.75rem;
    border-radius: 2rem;
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    background: var(--color-background-secondary);
    border: 1px solid var(--color-border);
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .search-suggestion-pill:hover {
    color: var(--color-primary, #6366f1);
    border-color: var(--color-primary, #6366f1);
    background: rgba(var(--color-primary-rgb, 99, 102, 241), 0.05);
  }

  /* ---- No results & Error ---- */
  .search-no-results,
  .search-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2.5rem 1rem;
    gap: 0.375rem;
    color: var(--color-text-muted);
  }

  .search-no-results svg,
  .search-error svg {
    width: 2rem;
    height: 2rem;
    opacity: 0.4;
    margin-bottom: 0.25rem;
  }

  .search-no-results p,
  .search-error p {
    font-size: 0.8125rem;
    margin: 0;
  }

  .search-no-results-hint {
    font-size: 0.75rem !important;
    opacity: 0.7;
  }

  /* ---- Footer ---- */
  .search-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.625rem 1.25rem;
    border-top: 1px solid var(--color-border);
    background: var(--color-background-secondary);
    font-size: 0.6875rem;
    color: var(--color-text-muted);
    border-radius: 0 0 1rem 1rem;
  }

  .search-footer-keys {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .search-footer-key {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .search-footer-key kbd {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    background: var(--color-background-tertiary);
    font-size: 0.625rem;
    font-family: inherit;
    border: none;
    min-width: 1.25rem;
  }

  .search-footer-brand {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .search-footer-ai-icon {
    width: 0.75rem;
    height: 0.75rem;
    color: var(--color-primary, #6366f1);
  }

  /* ---- Mobile ---- */
  @media (max-width: 640px) {
    .search-modal-content {
      left: 0.5rem;
      right: 0.5rem;
      top: 5vh;
    }

    .search-results {
      max-height: 65vh;
    }
  }
</style>
