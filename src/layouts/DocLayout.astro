---
/**
 * DocLayout - Documentation page layout with Mintlify-style design
 * Features: Sidebar navigation, header, table of contents, dark mode, i18n
 */

import BaseLayout from "./BaseLayout.astro";
import Header from "../components/Header.astro";
import Sidebar from "../components/Sidebar.astro";
import TableOfContents from "../components/TableOfContents.astro";
import Breadcrumbs from "../components/Breadcrumbs.astro";
import Footer from "../components/Footer.astro";
import AIChat from "../components/AIChat.astro";
import { getDocuments, getAllSettings, type Document } from "../lib/cms";
import { extractSlugFromPath, isIndexFile } from "../lib/doc-helpers";
import { getCollection } from "astro:content";
import {
  localeHrefLang,
  defaultLocale,
  isValidLocale,
  type Locale,
} from "../lib/i18n";

interface Props {
  // Page metadata
  title: string;
  description?: string;
  breadcrumbTitle?: string;
  icon?: string;
  sidebarIcon?: string;

  // SEO
  ogTitle?: string;
  ogDescription?: string;
  ogImage?: string;
  canonical?: string;
  noindex?: boolean;

  // Content
  collection?: string;
  section?: string;
  category?: string;
  readingTime?: number;
  tldr?: string;
  keyTakeaways?: string[];

  // Article schema metadata
  author?: string;
  authorUrl?: string;
  datePublished?: string;
  dateModified?: string;
  heroImage?: string;
  imageAlt?: string;

  // Table of Contents
  headings?: Array<{ depth: number; slug: string; text: string }>;

  // Navigation
  currentPath?: string;

  /** Override sidebar documents (used by SSR pages that fetch from CMS API) */
  sidebarDocuments?: Document[];

  // i18n
  locale?: Locale;
  availableTranslations?: Locale[];
  translationSlugs?: Partial<Record<Locale, string>>;
}

const {
  title,
  description,
  breadcrumbTitle,
  icon,
  sidebarIcon,
  ogTitle,
  ogDescription,
  ogImage,
  canonical,
  noindex,
  collection = "docs",
  section,
  category,
  readingTime,
  tldr,
  keyTakeaways,
  author,
  authorUrl,
  datePublished,
  dateModified,
  heroImage,
  imageAlt,
  headings = [],
  currentPath,
  sidebarDocuments: propSidebarDocuments,
  locale: propLocale,
  availableTranslations = [],
  translationSlugs = {},
} = Astro.props;

// Determine current locale
const urlSegments = (currentPath || Astro.url.pathname)
  .split("/")
  .filter(Boolean);
const urlLocale = urlSegments[0];
const currentLocale: Locale =
  propLocale || (isValidLocale(urlLocale) ? urlLocale : defaultLocale);

// Determine available translations (default to current locale if not provided)
const effectiveTranslations: Locale[] =
  availableTranslations.length > 0 ? availableTranslations : [currentLocale];

// Fetch navigation documents and settings
let documents: Document[] = [];
let settings: any = null;

try {
  if (propSidebarDocuments && propSidebarDocuments.length > 0) {
    // SSR pages pass their own sidebar documents (fetched from CMS API)
    documents = propSidebarDocuments;
    settings = (await getAllSettings()) || null;
  } else if (collection === 'api') {
    // For static API pages, build sidebar from Astro content collection
    const allDocs = await getCollection('docs');
    const apiDocs = allDocs.filter(d => d.data.collection === 'api' && d.data.visible !== false);
    documents = apiDocs.map(d => ({
      id: d.id,
      title: d.data.title,
      description: d.data.description || '',
      content: '',
      collection: 'api',
      locale: d.data.locale || 'en',
      type: d.data.type || 'article',
      path: d.data.path || '',
      slug: d.data.slug || '',
      visible: d.data.visible !== false ? true : false,
      sidebar_position: d.data.sidebar_position,
      order_num: d.data.order_num,
      weight: d.data.weight,
      item_name: d.data.item_name || d.data.title,
      icon: d.data.icon,
      sidebar_icon: d.data.sidebar_icon,
      headline: d.data.headline,
    })) as Document[];
    settings = (await getAllSettings()) || null;
  } else {
    const [docsResponse, settingsResponse] = await Promise.all([
      getDocuments({ collection, visible: true, limit: 2000 }),
      getAllSettings(),
    ]);
    documents = docsResponse.documents;
    settings = settingsResponse;
  }
} catch (error) {
  console.warn("Failed to fetch CMS data for navigation");
}

// Filter TOC to only h2 and h3
const tocHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3);

function formatSegmentLabel(segment: string): string {
  return decodeURIComponent(segment)
    .replace(/[-_]/g, " ")
    .replace(/([a-z])([A-Z])/g, "$1 $2")
    .replace(/\b\w/g, (c) => c.toUpperCase())
    .replace(/\bApi\b/g, "API")
    .replace(/\bSdk\b/g, "SDK")
    .replace(/\bCli\b/g, "CLI")
    .replace(/\bUi\b/g, "UI")
    .replace(/\bSso\b/g, "SSO")
    .replace(/\bMdm\b/g, "MDM")
    .replace(/\bEmm\b/g, "EMM")
    .replace(/\bAdm\b/g, "ADM")
    .trim();
}

function getMenuLabel(doc: Document): string {
  if (doc.item_name && doc.item_name !== "null") return doc.item_name;
  if (doc.section && Array.isArray(doc.section) && doc.section.length > 0) return doc.section[0];
  if (doc.section && typeof doc.section === "string") return doc.section;
  return doc.title;
}

function buildBreadcrumbItems() {
  const pathname = currentPath || Astro.url.pathname;
  const segments = pathname.split("/").filter(Boolean);
  const pathLocale = isValidLocale(segments[0]) ? segments[0] : defaultLocale;
  const pathSegments = isValidLocale(segments[0])
    ? segments.slice(1)
    : segments;
  const folderLabels = new Map<string, string>();
  const folderIcons = new Map<string, string>();

  // 1. Collect labels from manual sidebar configuration (highest priority)
  const sideMenu = settings?.navigation?.sideMenu;
  if (sideMenu?.mode === "manual" && sideMenu.items) {
    const collectManualLabels = (items: any[]) => {
      for (const item of items) {
        if (item.folder && item.label) {
          // Clean folder path to use as slug key
          const slug = item.folder
            .replace(/^[a-z]{2}\//, "") // remove locale
            .replace(/^docs\//, "") // remove docs prefix
            .replace(/^\/+|\/+$/g, "")
            .toLowerCase();
          folderLabels.set(slug, item.label);
          if (item.icon) folderIcons.set(slug, item.icon);
        }
        if (item.children) {
          collectManualLabels(item.children);
        }
      }
    };
    collectManualLabels(sideMenu.items);
  }

  // 2. Collect labels from index files (fallback)
  for (const doc of documents) {
    if (doc.locale !== currentLocale) continue;
    if (!doc.path) continue;
    if (!isIndexFile(doc) && doc.type !== "archive") continue;
    const slug = extractSlugFromPath(doc.path, true);
    if (!slug) continue;
    const label = getMenuLabel(doc);
    const icon = doc.sidebar_icon || doc.icon;
    if (label && !folderLabels.has(slug)) folderLabels.set(slug, label);
    if (icon && !folderIcons.has(slug)) folderIcons.set(slug, icon);
  }

  const items: Array<{ label: string; href: string; current?: boolean; icon?: string }> = [
    { label: "Home", href: `/${pathLocale}/` },
  ];
  let slugAcc = "";
  let hrefAcc = `/${pathLocale}`;
  const finalTitle = breadcrumbTitle || title;

  for (let i = 0; i < pathSegments.length; i += 1) {
    const segment = pathSegments[i];
    const decodedSegment = decodeURIComponent(segment);
    const isLast = i === pathSegments.length - 1;
    slugAcc = slugAcc ? `${slugAcc}/${decodedSegment}` : decodedSegment;
    hrefAcc += `/${segment}`;
    const label = isLast ? finalTitle : folderLabels.get(slugAcc) || formatSegmentLabel(segment);
    const itemIcon = isLast ? (sidebarIcon || icon) : folderIcons.get(slugAcc);
    items.push({
      label,
      href: hrefAcc,
      current: isLast,
      icon: itemIcon,
    });
  }

  return items;
}

const breadcrumbItems = buildBreadcrumbItems();

// --- Next/Previous Navigation Logic ---
interface FlatNavItem {
  label: string;
  href: string;
}

function flattenNavigation(docs: Document[], sideMenu: any, currentLocale: Locale, currentPath: string): FlatNavItem[] {
  const isManualMode = sideMenu?.mode === 'manual' && sideMenu.items && sideMenu.items.length > 0;
  const flatLinks: FlatNavItem[] = [];

  if (isManualMode) {
    const products: any[] = [];
    const nonProductItems: any[] = [];
    
    for (const item of sideMenu.items) {
      if (item.type === 'product' && !item.hidden) {
        products.push(item);
      } else if (item.type !== 'tab' && !item.hidden) {
        nonProductItems.push(item);
      }
    }

    const itemsToProcess = products.length > 0 ? nonProductItems : sideMenu.items;

    function processManualItems(items: any[]) {
      for (const item of items) {
        if (item.hidden) continue;
        if (item.type === 'page' || item.type === 'anchor') {
          if (item.href && !item.href.startsWith('http')) {
            flatLinks.push({ label: item.label, href: item.href });
          }
        }
        if (item.children) {
          processManualItems(item.children);
        }
      }
    }
    processManualItems(itemsToProcess);
  } else {
    // Auto mode - match Sidebar.astro sorting
    const sortedDocs = [...docs]
      .filter(doc => doc.visible !== false && doc.visible !== 0 && doc.locale === currentLocale)
      .sort((a, b) => {
        const posA = a.sidebar_position ?? a.order_num ?? a.weight ?? 999;
        const posB = b.sidebar_position ?? b.order_num ?? b.weight ?? 999;
        if (posA !== posB) return posA - posB;
        return (a.path || '').localeCompare(b.path || '');
      });

    for (const doc of sortedDocs) {
      // Skip index files and archives in auto mode - match Sidebar.astro
      if (isIndexFile(doc) || doc.type === 'archive') continue;
      
      const slug = doc.path ? extractSlugFromPath(doc.path, false) : (doc.slug?.replace(/^docs\//, '') || doc.id);
      if (!slug) continue;
      
      const href = `/${currentLocale}/${slug.toLowerCase()}`;
      flatLinks.push({
        label: (doc.item_name && doc.item_name !== 'null') ? doc.item_name : doc.title,
        href
      });
    }
  }
  return flatLinks;
}

const flatNav = flattenNavigation(documents, settings?.navigation?.sideMenu, currentLocale, currentPath || Astro.url.pathname);
const currentNormalizedPath = decodeURIComponent((currentPath || Astro.url.pathname)).replace(/\/+$/, '');
const currentIndex = flatNav.findIndex(item => decodeURIComponent(item.href).replace(/\/+$/, '') === currentNormalizedPath);

const prevPage = currentIndex > 0 ? flatNav[currentIndex - 1] : undefined;
const nextPage = currentIndex >= 0 && currentIndex < flatNav.length - 1 ? flatNav[currentIndex + 1] : undefined;

const editUrl = settings?.navigation?.footer?.editUrl;
const hasFooter = !!(prevPage || nextPage || editUrl);

// Build Article Schema for SEO/LLM optimization
const siteUrl = settings?.seo?.siteUrl || Astro.url.origin;
const siteName = settings?.seo?.siteName || "Documentation";
const pageUrl = new URL(currentPath || Astro.url.pathname, siteUrl).href;

// Heuristic: Detect content type based on URL patterns and content
const isHowTo =
  (currentPath || "").includes("/guide") ||
  (currentPath || "").includes("/tutorial") ||
  (currentPath || "").includes("/how-to") ||
  headings.some((h) => h.text.toLowerCase().includes("step"));

const isFaq = headings.filter((h) => h.text.includes("?")).length >= 2;

// Build Article schema
const articleSchema: Record<string, any> = {
  "@context": "https://schema.org",
  "@type": isHowTo ? "HowTo" : "Article",
  headline: title,
  description: description || "",
  url: pageUrl,
  inLanguage: localeHrefLang[currentLocale] || currentLocale,
  isPartOf: {
    "@type": "WebSite",
    name: siteName,
    url: siteUrl,
  },
  publisher: {
    "@type": "Organization",
    name: siteName,
    url: siteUrl,
    ...(settings?.appearance?.branding?.logo && {
      logo: {
        "@type": "ImageObject",
        url: new URL(settings.appearance.branding.logo, siteUrl).href,
      },
    }),
  },
};

// Add dates if available
if (datePublished) {
  articleSchema.datePublished = datePublished;
}
if (dateModified) {
  articleSchema.dateModified = dateModified;
}

// Add author if available
if (author) {
  articleSchema.author = {
    "@type": "Person",
    name: author,
    ...(authorUrl && { url: authorUrl }),
  };
}

// Add image if available
if (heroImage || ogImage) {
  articleSchema.image = {
    "@type": "ImageObject",
    url: new URL(heroImage || ogImage || "", siteUrl).href,
    ...(imageAlt && { description: imageAlt }),
  };
}

// Add HowTo specific fields
if (isHowTo && headings.length > 0) {
  articleSchema.step = headings
    .filter((h) => h.depth === 2)
    .map((h, index) => ({
      "@type": "HowToStep",
      position: index + 1,
      name: h.text,
      url: `${pageUrl}#${h.slug}`,
    }));
}

// Add reading time as timeRequired for HowTo
if (isHowTo && readingTime) {
  articleSchema.totalTime = `PT${readingTime}M`;
}

// Build FAQ schema if detected
const faqSchema = isFaq
  ? {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      mainEntity: headings
        .filter((h) => h.text.includes("?"))
        .slice(0, 10) // Limit to 10 FAQs
        .map((h) => ({
          "@type": "Question",
          name: h.text,
          acceptedAnswer: {
            "@type": "Answer",
            text: `See section: ${h.text}`, // Placeholder - actual content is in the page
          },
        })),
    }
  : null;
---

<BaseLayout
  title={title}
  description={description}
  ogTitle={ogTitle}
  ogDescription={ogDescription}
  ogImage={ogImage}
  canonical={canonical}
  noindex={noindex}
  locale={currentLocale}
  availableTranslations={effectiveTranslations}
>
  <!-- Article Schema for SEO/LLM optimization -->
  <Fragment slot="head">
    <script
      type="application/ld+json"
      set:html={JSON.stringify(articleSchema)}
    />
    {
      faqSchema && (
        <script
          type="application/ld+json"
          set:html={JSON.stringify(faqSchema)}
        />
      )
    }
    <!-- LLMs.txt reference -->
    <link rel="author" href="/llms.txt" type="text/plain" />
  </Fragment>
  <div class="docs-layout">
    <!-- Sidebar -->
    <Sidebar
      documents={documents}
      currentPath={currentPath || Astro.url.pathname}
      logoUrl={settings?.appearance?.branding?.logo ||
        settings?.appearance?.logoUrl}
      logoDarkUrl={settings?.appearance?.branding?.logoDark}
      logoIconUrl={settings?.appearance?.branding?.logoIcon}
      logoIconDarkUrl={settings?.appearance?.branding?.logoIconDark}
      logoWidth={settings?.appearance?.branding?.logoWidth}
      logoHeight={settings?.appearance?.branding?.logoHeight}
      siteName={settings?.seo?.siteName}
      supportedLocales={settings?.content?.supportedLocales}
      defaultLocale={settings?.content?.defaultLocale}
      sideMenu={collection === 'api' ? undefined : settings?.navigation?.sideMenu}
      locale={currentLocale}
      availableTranslations={effectiveTranslations}
      translationSlugs={translationSlugs}
    />

    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Header -->
      <Header
        navigation={settings?.navigation?.header}
        topMenu={settings?.navigation?.topMenu}
        sideMenu={settings?.navigation?.sideMenu}
        locale={currentLocale}
        faviconUrl={settings?.appearance?.branding?.favicon || settings?.appearance?.faviconUrl || '/favicon.svg'}
      />

      <!-- Content area with container and AI chat side by side -->
      <div class="content-area">
        <!-- Content Container with border - wraps content + TOC -->
        <div class="content-container">
          <!-- Article Content -->
          <main class:list={["article-main scrollbar-hide", { "no-footer": !hasFooter }]}>
            <!-- Breadcrumbs - SEO optimized -->
            <Breadcrumbs
              items={breadcrumbItems}
              currentPath={currentPath || Astro.url.pathname}
              currentTitle={breadcrumbTitle || title}
              collection={collection}
              section={section}
              category={category}
              siteName={settings?.seo?.siteName}
            />

            <!-- Article Header -->
            <header class="article-header">
              <h1 class="article-title">{title}</h1>
              {description && <p class="article-description">{description}</p>}
              {
                readingTime && (
                  <p class="reading-time">{readingTime} min read</p>
                )
              }
            </header>

            <!-- TL;DR Box -->
            {
              tldr && (
                <div class="tldr-box">
                  <p class="tldr-title">TL;DR</p>
                  <p class="tldr-content">{tldr}</p>
                </div>
              )
            }

            <!-- Article Content -->
            <article class="article-content">
              <slot />
            </article>

            <!-- Key Takeaways -->
            {
              keyTakeaways && keyTakeaways.length > 0 && (
                <div class="takeaways">
                  <h2 class="takeaways-title">Key Takeaways</h2>
                  <ul class="takeaways-list">
                    {keyTakeaways.map((item) => (
                      <li class="takeaways-item">
                        <svg
                          class="takeaways-icon"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M5 13l4 4L19 7"
                          />
                        </svg>
                        <span>{item}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )
            }

            <!-- Footer Navigation -->
            {hasFooter && (
              <div class="mt-auto">
                <Footer
                  prevPage={prevPage ? { title: prevPage.label, href: prevPage.href } : undefined}
                  nextPage={nextPage ? { title: nextPage.label, href: nextPage.href } : undefined}
                  editUrl={editUrl}
                  lastUpdated={dateModified}
                />
              </div>
            )}
          </main>

          <!-- Table of Contents (Right Sidebar) -->
          <div class="toc-wrapper">
            {
              tocHeadings.length > 0 && (
                <TableOfContents headings={tocHeadings} />
              )
            }
          </div>
        </div>

        <!-- AI Chat Panel - Part of layout, resizes container -->
        <AIChat />
      </div>
    </div>
  </div>

  <!-- Mobile menu overlay -->
  <div
    id="sidebar-overlay"
    class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden"
  >
  </div>

  <!-- Mobile menu toggle script -->
  <script>
    function initMobileMenu() {
      const menuBtn = document.getElementById("mobile-menu-btn");
      const sidebar = document.querySelector(".sidebar");
      const overlay = document.getElementById("sidebar-overlay");

      if (menuBtn && sidebar && overlay) {
        menuBtn.addEventListener("click", () => {
          sidebar.classList.toggle("open");
          overlay.classList.toggle("hidden");
          document.body.classList.toggle("overflow-hidden");
        });

        overlay.addEventListener("click", () => {
          sidebar.classList.remove("open");
          overlay.classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
        });
      }
    }

    initMobileMenu();
    document.addEventListener("astro:after-swap", initMobileMenu);
  </script>

  <!-- Code block copy button script -->
  <script>
    const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
    const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`;

    function initCodeCopy() {
      // Add copy buttons to standalone pre blocks (not inside .doc-code-block which already have one)
      document.querySelectorAll('.article-content pre').forEach((pre) => {
        if (pre.closest('.doc-code-block')) return; // skip titled blocks
        if (pre.querySelector('.code-copy-btn')) return; // already added

        const wrapper = document.createElement('div');
        wrapper.className = 'code-block-wrapper';
        pre.parentNode!.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);

        const btn = document.createElement('button');
        btn.className = 'code-copy-btn';
        btn.innerHTML = copyIcon;
        btn.title = 'Copy code';
        wrapper.appendChild(btn);
      });

      // Handle all copy buttons (both titled .doc-code-copy and standalone .code-copy-btn)
      document.querySelectorAll('.doc-code-copy, .code-copy-btn').forEach((btn) => {
        btn.replaceWith(btn.cloneNode(true)); // remove old listeners
      });

      document.querySelectorAll('.doc-code-copy, .code-copy-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const container = btn.closest('.doc-code-block') || btn.closest('.code-block-wrapper');
          const code = container?.querySelector('code');
          if (!code) return;

          try {
            await navigator.clipboard.writeText(code.textContent || '');
            const isTitled = btn.classList.contains('doc-code-copy');

            if (isTitled) {
              btn.classList.add('copied');
              const span = btn.querySelector('span');
              if (span) span.textContent = 'Copied!';
              setTimeout(() => {
                btn.classList.remove('copied');
                if (span) span.textContent = 'Copy';
              }, 2000);
            } else {
              btn.innerHTML = checkIcon;
              btn.classList.add('copied');
              setTimeout(() => {
                btn.innerHTML = copyIcon;
                btn.classList.remove('copied');
              }, 2000);
            }
          } catch (e) {
            // Fallback for older browsers
            const textarea = document.createElement('textarea');
            textarea.value = code.textContent || '';
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
          }
        });
      });
    }

    initCodeCopy();
    document.addEventListener('astro:after-swap', initCodeCopy);
  </script>

  <!-- Accordion toggle script (doc accordions + API response accordions) -->
  <script is:inline>
    function initAccordions() {
      document.querySelectorAll('[data-accordion-trigger]').forEach(function(trigger) {
        if (trigger.dataset.accordionBound) return;
        trigger.dataset.accordionBound = 'true';

        trigger.addEventListener('click', function() {
          var accordion = trigger.closest('[data-accordion]');
          if (!accordion) return;
          var isOpen = accordion.classList.contains('open');
          accordion.classList.toggle('open', !isOpen);
          trigger.setAttribute('aria-expanded', (!isOpen).toString());
        });
      });

      document.querySelectorAll('[data-tabs]').forEach(function(tabGroup) {
        if (tabGroup.dataset.tabsBound) return;
        tabGroup.dataset.tabsBound = 'true';

        var buttons = tabGroup.querySelectorAll('[data-tab-btn]');
        var panels = tabGroup.querySelectorAll('[data-tab-panel]');

        buttons.forEach(function(btn) {
          btn.addEventListener('click', function() {
            var target = btn.dataset.tabBtn;
            buttons.forEach(function(b) { b.classList.remove('active'); });
            panels.forEach(function(p) { p.style.display = p.dataset.tabPanel === target ? 'block' : 'none'; });
            btn.classList.add('active');
          });
        });
      });
    }

    initAccordions();
    document.addEventListener('astro:after-swap', initAccordions);

    // Copy API endpoint path on click
    function initPathCopy() {
      document.querySelectorAll('[data-copy-path]').forEach(function(el) {
        if (el.dataset.pathCopyBound) return;
        el.dataset.pathCopyBound = 'true';

        el.addEventListener('click', function() {
          var text = el.dataset.copyPath;
          if (!text) return;

          navigator.clipboard.writeText(text).then(function() {
            el.classList.add('copied');
            var orig = el.getAttribute('title');
            el.setAttribute('title', 'Copied!');
            setTimeout(function() {
              el.classList.remove('copied');
              el.setAttribute('title', orig || 'Click to copy');
            }, 1500);
          });
        });
      });
    }

    initPathCopy();
    document.addEventListener('astro:after-swap', initPathCopy);

    // Collapsible cards (Authorization section)
    function initCollapsibles() {
      document.querySelectorAll('[data-collapsible]').forEach(function(card) {
        if (card.dataset.collapsibleBound) return;
        card.dataset.collapsibleBound = 'true';
        var trigger = card.querySelector('[data-collapsible-trigger]');
        if (!trigger) return;
        trigger.addEventListener('click', function() {
          card.classList.toggle('collapsed');
          var expanded = !card.classList.contains('collapsed');
          trigger.setAttribute('aria-expanded', String(expanded));
        });
      });
    }
    initCollapsibles();
    document.addEventListener('astro:after-swap', initCollapsibles);

    // Body params tabs (Params / Example)
    function initBpTabs() {
      document.querySelectorAll('[data-bp-tabs]').forEach(function(tabGroup) {
        if (tabGroup.dataset.bpTabsBound) return;
        tabGroup.dataset.bpTabsBound = 'true';
        var tabs = tabGroup.querySelectorAll('[data-bp-tab]');
        var panels = tabGroup.querySelectorAll('[data-bp-panel]');
        tabs.forEach(function(tab) {
          tab.addEventListener('click', function() {
            var idx = tab.dataset.bpTabIndex;
            tabs.forEach(function(t) { t.classList.remove('active'); });
            panels.forEach(function(p) { p.classList.remove('active'); });
            tab.classList.add('active');
            var target = tabGroup.querySelector('[data-bp-panel][data-bp-tab-index="' + idx + '"]');
            if (target) target.classList.add('active');
          });
        });
      });
    }
    initBpTabs();
    document.addEventListener('astro:after-swap', initBpTabs);

    // Collapsible nested body params (objects/arrays)
    function initBpCollapsibles() {
      document.querySelectorAll('[data-bp-collapsible]').forEach(function(row) {
        if (row.dataset.bpBound) return;
        row.dataset.bpBound = 'true';
        var trigger = row.querySelector('[data-bp-trigger]');
        if (!trigger) return;
        trigger.addEventListener('click', function() {
          row.classList.toggle('bp-collapsed');
          var expanded = !row.classList.contains('bp-collapsed');
          trigger.setAttribute('aria-expanded', String(expanded));
        });
      });
    }
    initBpCollapsibles();
    document.addEventListener('astro:after-swap', initBpCollapsibles);
  </script>
</BaseLayout>

<style>
  /* Content area - flex container for main container + AI chat */
  .content-area {
    display: flex;
    gap: 1rem;
    margin: 0 0 1.5rem 1.5rem;
    height: calc(100vh - var(--header-height) - 1.5rem);
  }

  /* Add right margin only when AI chat is open */
  :global(.ai-chat-open) .content-area {
    margin-right: 1.5rem;
  }

  /* Content container - wraps content + TOC with border */
  .content-container {
    display: flex;
    align-items: flex-start;
    gap: 2rem;
    flex: 1;
    min-width: 0;
    padding: 2rem 2rem 0 2rem;
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 1rem;
    height: 100%;
    overflow: hidden;
    transition: flex 0.3s ease;
    position: relative;
    justify-content: center;
  }

  /* Bottom gradient fade */
  .content-container::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3rem;
    background: linear-gradient(
      to bottom,
      transparent,
      var(--color-bg-primary)
    );
    pointer-events: none;
    border-radius: 0 0 1rem 1rem;
  }

  :global(.dark) .content-container {
    background: var(--color-background-secondary);
    border-color: var(--color-border);
  }

  :global(.dark) .content-container::after {
    background: linear-gradient(
      to bottom,
      transparent,
      var(--color-background-secondary)
    );
  }

  /* TOC wrapper - only hides when AI chat is open AND not enough space */
  .toc-wrapper {
    display: contents;
  }

  /* Hide TOC when AI chat is open only on screens below 1600px */
  @media (max-width: 1600px) {
    :global(.ai-chat-open) .toc-wrapper {
      display: none;
    }
  }

  /* Article main section */
  .article-main {
    flex: 1;
    min-width: 0;
    max-width: 48rem;
    height: 100%;
    overflow-y: auto;
    padding-right: 1rem;
    display: flex;
    flex-direction: column;
  }

  .article-main.no-footer {
    padding-bottom: 32px;
  }

  /* Footer inside article-main */
  .article-main :global(footer) {
    margin-bottom: 48px;
  }

  /* Article header - introduction section with distinct styling */
  .article-header {
    margin-bottom: 2.5rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--color-border);
  }

  .article-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text-primary);
    line-height: 1.2;
    margin: 0;
    letter-spacing: -0.02em;
  }

  @media (min-width: 768px) {
    .article-title {
      font-size: 1.875rem;
    }
  }

  .article-description {
    font-size: 1.0625rem;
    color: var(--color-text-secondary);
    margin-top: 0.75rem;
    line-height: 1.65;
    max-width: 40rem;
  }

  .reading-time {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    margin-top: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .reading-time::before {
    content: "";
    width: 4px;
    height: 4px;
    background: var(--color-text-muted);
    border-radius: 50%;
  }

  /* TL;DR box styling */
  .tldr-box {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 0.75rem;
    padding: 1.25rem;
    margin-bottom: 2rem;
  }

  .tldr-title {
    font-weight: 600;
    color: var(--color-primary);
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .tldr-content {
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin: 0;
  }

  /* Key takeaways section */
  .takeaways {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-top: 2rem;
  }

  .takeaways-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 0 0 1rem 0;
  }

  .takeaways-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .takeaways-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.5rem 0;
    color: var(--color-text-secondary);
  }

  .takeaways-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--color-primary);
    flex-shrink: 0;
    margin-top: 0.125rem;
  }

  /* Responsive adjustments */
  @media (max-width: 1024px) {
    .content-area {
      flex-direction: column-reverse;
      margin: 0 1rem 1rem 1rem;
      height: calc(100vh - var(--header-height) - 1rem);
    }

    .content-container {
      flex-direction: column;
      padding: 1.5rem 1.5rem 0 1.5rem;
      border-radius: 1rem;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    .article-main {
      max-width: 100%;
      padding-right: 0;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
    }

    .article-header {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
    }
  }

  @media (max-width: 640px) {
    .content-area {
      margin: 0 0.75rem 0.75rem 0.75rem;
      height: calc(100vh - var(--header-height) - 0.75rem);
    }

    .content-container {
      padding: 1rem 1rem 0 1rem;
      border-radius: 1rem;
    }

    .article-header {
      margin-bottom: 1.5rem;
      padding-bottom: 1.25rem;
    }

    .article-description {
      font-size: 1rem;
    }
  }
</style>
